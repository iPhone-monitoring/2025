<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>過去相場グラフ - iPhone相場</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
<style>
    body {
        font-family: 'Inter', 'Noto Sans JP', sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    main {
        flex-grow: 1;
    }
    #graph-container {
        flex-grow:1;
        position:relative;
        min-height:60vh;
        background:#fff;
        border-radius:0.5rem;
        box-shadow:0 2px 4px rgba(0,0,0,0.05);
        margin-top:1rem;
    }
    #priceChart {
        position:absolute;
        top:0;
        left:0;
        width:100%;
        height:100%;
    }
    #graph-placeholder {
        position:absolute;
        inset:0;
        display:flex;
        justify-content:center;
        align-items:center;
        color:#94a3b8;
    }
    summary::-webkit-details-marker {
        display: none;
    }
    summary {
        list-style: none;
    }
    details[open] summary svg {
        transform: rotate(180deg);
    }
    .active-btn {
        background-color:#2563eb !important;
        color:white !important;
        border-color: #2563eb !important;
        box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
</style>
</head>
<body class="bg-slate-50 text-slate-800">

<!-- ヘッダー -->
<header class="bg-white shadow-md sticky top-0 z-10">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <a href="../index.html" class="text-2xl font-bold text-blue-600">iPhone相場</a>
        <nav class="hidden md:flex items-center space-x-6">
            <a href="../index.html" class="text-slate-600 hover:text-blue-600 font-semibold">ホーム</a>
            <!-- iPhone 17 ドロップダウン (クリック式) -->
            <div class="relative js-dropdown">
                <button data-dropdown-toggle="iphone17Dropdown" class="text-slate-600 hover:text-blue-600 font-semibold flex items-center">
                    iPhone 17
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="iphone17Dropdown" class="absolute hidden bg-white shadow-lg rounded-md py-2 w-56 z-20 border border-slate-100 top-full mt-2 right-0">
                    <a href="../iPhone17/overseas-prices.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">海外価格</a>
                    <a href="../iPhone17/market-graphs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場グラフ</a>
                    <a href="../iPhone17/market-prices-logs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場ログ</a>
                </div>
            </div>

            <!-- 過去データ ドロップダウン (クリック式) -->
            <div class="relative js-dropdown">
                <button data-dropdown-toggle="pastDataDropdown" class="text-slate-600 hover:text-blue-600 font-semibold flex items-center">
                    過去データ
                     <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="pastDataDropdown" class="absolute hidden bg-white shadow-lg rounded-md py-2 w-56 z-20 border border-slate-100 top-full mt-2 right-0">
                    <a href="market-graphs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場グラフ</a>
                    <a href="market-prices-logs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場ログ</a>
                </div>
            </div>
        </nav>
        <!-- ハンバーガーメニューボタン -->
        <button id="mobile-menu-button" class="block md:hidden text-slate-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
        </button>
    </div>
    <!-- モバイルメニュー -->
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-200">
        <a href="../index.html" class="block px-6 py-3 text-slate-600 hover:bg-blue-50 font-semibold">ホーム</a>
        <details class="w-full">
            <summary class="px-6 py-3 text-slate-600 hover:bg-blue-50 font-semibold flex justify-between items-center cursor-pointer">
                <span>iPhone 17</span>
                <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="bg-slate-50">
                <a href="../iPhone17/overseas-prices.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">海外価格</a>
                <a href="../iPhone17/market-graphs.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">相場グラフ</a>
                <a href="../iPhone17/market-prices-logs.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">相場ログ</a>
            </div>
        </details>
         <details class="w-full">
            <summary class="px-6 py-3 text-slate-600 hover:bg-blue-50 font-semibold flex justify-between items-center cursor-pointer">
                <span>過去データ</span>
                <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="bg-slate-50">
                <a href="market-graphs.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">相場グラフ</a>
                <a href="market-prices-logs.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">相場ログ</a>
            </div>
        </details>
    </div>
</header>

<main class="container mx-auto px-6 py-8 md:py-12">
    <h1 class="text-3xl font-bold text-slate-800 mb-6">相場グラフ</h1>
    
    <!-- ローディングスピナー -->
    <div id="loader" class="flex justify-center items-center py-20">
        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- メインコンテンツ (最初は非表示) -->
    <div id="main-content" class="hidden">
        <!-- Selector Container -->
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md mb-8">
            <div id="model-selector" class="space-y-3 border-b border-slate-200 pb-4">
                <div id="iphone14-series" class="flex flex-wrap justify-center gap-2"></div>
                <div id="iphone15-series" class="flex flex-wrap justify-center gap-2"></div>
                <div id="iphone16-series" class="flex flex-wrap justify-center gap-2"></div>
            </div>
            <div id="period-selector" class="flex flex-wrap justify-center gap-2 pt-4" style="display: none;">
                <!-- Periods will be populated by JS -->
            </div>
        </div>

        <div id="graph-container" class="w-full">
            <canvas id="priceChart" style="display:none;"></canvas>
            <div id="graph-placeholder">機種を選択してください</div>
        </div>
    </div>
</main>

<!-- フッター -->
<footer class="bg-slate-800 text-white mt-auto">
    <div class="container mx-auto px-6 py-8 text-center">
        <p>&copy; 2025 iPhone相場. All rights reserved.</p>
    </div>
</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=8162687&single=true&output=csv';

let allData = {};
let modelInfo = {};
let chartInstance = null;

function parsePrice(str){
  if(!str) return null;
  str = str.replace(/["¥,]/g,'').trim();
  const n = parseFloat(str);
  return isNaN(n)? null:n;
}

function formatLabel(dateStr, dateCol) {
    const specialCols = [0, 27, 55]; // A, AB, BD
    const dateParts = dateStr.split(' ');

    if (specialCols.includes(dateCol)) {
        // For A, AB, BD, if there's a time part like 0:00:00, hide it.
        return dateParts[0];
    } else {
        // For other columns, if there is time data, put it on a new line.
        if (dateParts.length > 1) {
            return [dateParts[0], dateParts.slice(1).join(' ')];
        } else {
            return dateStr;
        }
    }
}

function createChart(model, period){
  const canvas = document.getElementById('priceChart');
  const placeholder = document.getElementById('graph-placeholder');

  if(chartInstance){
    chartInstance.destroy();
    chartInstance = null;
  }

  canvas.style.display = 'block';
  placeholder.style.display = 'none';
  const ctx = canvas.getContext('2d');

  const chartData = allData[model]?.[period];
  if(!chartData || Object.keys(chartData.capacities).length === 0){
    placeholder.textContent='選択された期間のグラフデータがありません。';
    placeholder.style.display='flex';
    canvas.style.display='none';
    return;
  }

  const firstCapacityKey = Object.keys(chartData.capacities)[0];
  if (!firstCapacityKey) {
    placeholder.textContent='選択された期間のグラフデータがありません。';
    placeholder.style.display='flex';
    canvas.style.display='none';
    return;
  }

  const labels = chartData.capacities[firstCapacityKey].data.map(point => point.date);

  const colors = ['#3b82f6','#10b981','#f97316','#ec4899','#8b5cf6','#ef4444'];
  let colorIndex = 0;
  const datasets = [];
  const capacities = Object.keys(chartData.capacities).sort((a,b)=>parseInt(a)-parseInt(b));

  capacities.forEach(cap=>{
    const capData = chartData.capacities[cap];
    const color = colors[colorIndex % colors.length];

    const alignedPriceData = capData.data.map(point => point.price);

    datasets.push({
      label: cap,
      data: alignedPriceData,
      borderColor: color,
      borderWidth: 2.5,
      fill: false,
      pointRadius: 0,
      tension: 0.4,
      spanGaps: true
    });

    if(capData.list_price){
      datasets.push({
        label: cap+' 定価',
        data: new Array(labels.length).fill(capData.list_price),
        borderColor: color,
        borderWidth: 1.5,
        borderDash: [5,5],
        fill: false,
        pointRadius: 0,
        tension: 0.1
      });
    }
    colorIndex++;
  });

  chartInstance = new Chart(ctx,{
    type: 'line',
    data: {
        labels: labels,
        datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'category',
          title: { display: true, text: '日付' },
          ticks: {
            autoSkip: true,
            maxRotation: 45,
            minRotation: 45,
            maxTicksLimit: 10
          }
        },
        y: {
          title: { display: true, text: '価格 (円)' },
          ticks: { callback: v=>'¥'+v.toLocaleString() }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx){
              let label=ctx.dataset.label||'';
              if(label) label+=': ';
              if (ctx.parsed.y !== null) {
                label+='¥'+ctx.parsed.y.toLocaleString();
              }
              return label;
            }
          }
        }
      }
    }
  });
}

function selectPeriod(model, period, btn){
  document.querySelectorAll('#period-selector button').forEach(b=>b.classList.remove('active-btn'));
  btn.classList.add('active-btn');
  createChart(model, period);
}

function selectModel(model, btn){
  document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active-btn'));
  btn.classList.add('active-btn');

  const periodSelector = document.getElementById('period-selector');
  periodSelector.style.display = 'flex';
  periodSelector.innerHTML='';

  const periodOrder = ['1週間','1ヶ月','3ヶ月','6ヶ月','1年'];
  const periods = Array.from(modelInfo[model].periods);
  periods.sort((a,b)=> periodOrder.indexOf(a) - periodOrder.indexOf(b));

  periods.forEach(p=>{
    const btn=document.createElement('button');
    btn.textContent=p;
    btn.className='px-2 sm:px-4 py-2 text-xs font-semibold rounded-md transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200 border whitespace-nowrap';
    btn.addEventListener('click',()=>selectPeriod(model,p,btn));
    periodSelector.appendChild(btn);
  });

  const canvas = document.getElementById('priceChart');
  const placeholder = document.getElementById('graph-placeholder');
  canvas.style.display='none';
  placeholder.style.display='flex';
  placeholder.textContent='期間を選択してください';
  if(chartInstance){
    chartInstance.destroy();
    chartInstance=null;
  }
}

async function initializePage(){
  const loader = document.getElementById('loader');
  const mainContent = document.getElementById('main-content');
  const modelSelector = document.getElementById('model-selector');

  const showError = msg=>{
    modelSelector.innerHTML='';
    const placeholder=document.getElementById('graph-placeholder');
    placeholder.style.display='flex';
    placeholder.textContent=msg;
    // エラー時もローダーを隠してコンテンツを表示
    loader.style.display = 'none';
    mainContent.classList.remove('hidden');
  };

  try{
    const response = await fetch(CSV_URL);
    if(!response.ok) throw new Error('CSV取得失敗: '+response.statusText);
    const text = await response.text();
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));

    if(rows.length < 4) throw new Error('CSVデータが不十分です。');

    const modelsHeader = rows[0];
    const capacitiesHeader = rows[1];
    const listPricesHeader = rows[2];
    const dataRows = rows.slice(3);

    const listPriceMap = {};
    // 最初にヘッダー行をすべてスキャンして、機種・容量ごとの定価マップを作成
    for (let c = 1; c < modelsHeader.length; c++) {
        const model = (modelsHeader[c] || '').trim();
        const capacity = (capacitiesHeader[c] || '').trim();
        if (model && capacity) {
            const list_price = parsePrice(listPricesHeader[c]);
            if (list_price !== null) {
                const key = `${model}-${capacity}`;
                listPriceMap[key] = list_price;
            }
        }
    }

    const configBySeries = {
      'iPhone 14': {
        '1週間': { dateCol: 0, rows: 8, priceColStart: 1, priceColEnd: 12 },
        '1ヶ月': { dateCol: 0, rows: 31, priceColStart: 1, priceColEnd: 12 },
        '3ヶ月': { dateCol: 0, rows: 92, priceColStart: 1, priceColEnd: 12 },
        '6ヶ月': { dateCol: 0, rows: 182, priceColStart: 1, priceColEnd: 12 },
        '1年': { dateCol: 0, rows: 365, priceColStart: 1, priceColEnd: 12 }
      },
      'iPhone 15': {
        '1週間': { dateCol: 13, rows: 192, priceColStart: 14, priceColEnd: 26 },
        '1ヶ月': { dateCol: 13, rows: 744, priceColStart: 14, priceColEnd: 26 },
        '3ヶ月': { dateCol: 27, rows: 92, priceColStart: 28, priceColEnd: 40 },
        '6ヶ月': { dateCol: 27, rows: 182, priceColStart: 28, priceColEnd: 40 },
        '1年': { dateCol: 27, rows: 364, priceColStart: 28, priceColEnd: 40 }
      },
      'iPhone 16': {
        '1週間': { dateCol: 41, rows: 192, priceColStart: 42, priceColEnd: 54 },
        '1ヶ月': { dateCol: 41, rows: 744, priceColStart: 42, priceColEnd: 54 },
        '3ヶ月': { dateCol: 55, rows: 92, priceColStart: 56, priceColEnd: 68 },
        '6ヶ月': { dateCol: 55, rows: 182, priceColStart: 56, priceColEnd: 68 },
        '1年': { dateCol: 55, rows: 365, priceColStart: 56, priceColEnd: 68 }
      }
    };

    for (const seriesKey in configBySeries) {
      const seriesPeriods = configBySeries[seriesKey];
      for (const periodName in seriesPeriods) {
        const config = seriesPeriods[periodName];
        const { dateCol, rows: numRows, priceColStart, priceColEnd } = config;
        const relevantRows = dataRows.slice(0, numRows);

        for (let c = priceColStart; c <= priceColEnd; c++) {
          const model = (modelsHeader[c] || '').trim();
          const capacity = (capacitiesHeader[c] || '').trim();
          
          if (!model || model === '機種' || !capacity) continue;

          // マップから定価を確実に取得
          const list_price = listPriceMap[`${model}-${capacity}`] || null;

          if (!allData[model]) {
            allData[model] = {};
            modelInfo[model] = { periods: new Set() };
          }
          if (!allData[model][periodName]) {
            allData[model][periodName] = { capacities: {} };
          }
          if (!allData[model][periodName].capacities[capacity]) {
            allData[model][periodName].capacities[capacity] = {
                list_price: list_price,
                data: []
            };
          }
          modelInfo[model].periods.add(periodName);

          const currentSeriesData = allData[model][periodName].capacities[capacity].data;

          relevantRows.forEach(row => {
            const dateStr = row[dateCol]?.trim();
            if (dateStr) {
                const price = parsePrice(row[c]);
                const formattedDate = formatLabel(dateStr, dateCol);
                currentSeriesData.push({ date: formattedDate, price: price });
            }
          });
        }
      }
    }

    const modelsBySeries = {
        'iphone14-series': ['iPhone 14', 'iPhone 14 Plus', 'iPhone 14 Pro', 'iPhone 14 Pro MAX'],
        'iphone15-series': ['iPhone 15', 'iPhone 15 Plus', 'iPhone 15 Pro', 'iPhone 15 Pro MAX'],
        'iphone16-series': ['iPhone 16', 'iPhone 16 Plus', 'iPhone 16 Pro', 'iPhone 16 Pro MAX']
    };

    Object.keys(modelsBySeries).forEach(seriesId => {
        const seriesContainer = document.getElementById(seriesId);
        const models = modelsBySeries[seriesId];

        models.forEach(m => {
            if (!allData[m]) return;
            const btn = document.createElement('button');
            btn.textContent = m;
            btn.className = 'w-[calc(50%-0.5rem)] sm:w-auto px-2 sm:px-4 py-2 text-[11px] sm:text-sm text-center font-semibold rounded-md transition-colors bg-white text-slate-700 shadow-sm hover:bg-slate-100 border whitespace-nowrap';
            btn.addEventListener('click', () => selectModel(m, btn));
            seriesContainer.appendChild(btn);
        });
    });

    if(Object.keys(modelInfo).length === 0) {
        showError('解析できるデータがありません');
    } else {
        // 正常終了時にローダーを隠してコンテンツを表示
        loader.style.display = 'none';
        mainContent.classList.remove('hidden');
    }

  }catch(e){
    console.error(e);
    showError('データ取得または処理に失敗しました: '+e.message);
  }
}

function setupEventListeners() {
    // デスクトップ用ドロップダウン
    const dropdownToggles = document.querySelectorAll('[data-dropdown-toggle]');
    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function(event) {
            event.stopPropagation();
            const dropdownId = this.getAttribute('data-dropdown-toggle');
            const dropdownMenu = document.getElementById(dropdownId);

            document.querySelectorAll('.js-dropdown [id$="Dropdown"]').forEach(menu => {
                if (menu.id !== dropdownId) {
                    menu.classList.add('hidden');
                }
            });
            dropdownMenu.classList.toggle('hidden');
        });
    });

    // 他の場所をクリックしたらドロップダウンを閉じる
    window.addEventListener('click', function(event) {
        if (!event.target.closest('.js-dropdown')) {
            document.querySelectorAll('.js-dropdown [id$="Dropdown"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // モバイルメニューの制御
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenuButton && mobileMenu) {
        mobileMenuButton.addEventListener('click', (event) => {
            event.stopPropagation();
            mobileMenu.classList.toggle('hidden');
        });
    }

    // モバイルメニュー内のアコーディオン
    const detailsElements = document.querySelectorAll('#mobile-menu details');
    detailsElements.forEach(details => {
        details.addEventListener('toggle', function() {
            if (this.open) {
                // 他の開いているdetailsを閉じる
                detailsElements.forEach(otherDetails => {
                    if (otherDetails !== this && otherDetails.open) {
                        otherDetails.removeAttribute('open');
                    }
                });
            }
        });
    });
}


document.addEventListener('DOMContentLoaded', () => {
    // Day.jsのプラグインがグローバルスコープに読み込まれるのを待ってから拡張する
    if (window.dayjs_plugin_customParseFormat) {
        dayjs.extend(window.dayjs_plugin_customParseFormat);
    }
    if (window.dayjs_plugin_utc) {
        dayjs.extend(window.dayjs_plugin_utc);
    }
    if (window.dayjs_plugin_timezone) {
        dayjs.extend(window.dayjs_plugin_timezone);
    }
    initializePage();
    setupEventListeners();
});
</script>

</body>
</html>
