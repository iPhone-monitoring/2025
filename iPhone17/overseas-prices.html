<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·å¤–ä¾¡æ ¼ - iPhoneç›¸å ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        .active-btn {
            background-color:#2563eb !important;
            color:white !important;
            border-color: #2563eb !important;
            box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        #capacity-selector:not(.visible){ display:none; }
        summary::-webkit-details-marker {
            display: none;
        }
        summary {
            list-style: none;
        }
        details[open] summary svg {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header class="bg-white shadow-md sticky top-0 z-10">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <a href="../index.html" class="text-2xl font-bold text-blue-600">iPhoneç›¸å ´</a>
        <nav class="hidden md:flex items-center space-x-6">
            <a href="../index.html" class="text-slate-600 hover:text-blue-600 font-semibold">ãƒ›ãƒ¼ãƒ </a>
            <!-- iPhone 17 ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ (ã‚¯ãƒªãƒƒã‚¯å¼) -->
            <div class="relative js-dropdown">
                <button data-dropdown-toggle="iphone17Dropdown" class="text-slate-600 hover:text-blue-600 font-semibold flex items-center">
                    iPhone 17
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="iphone17Dropdown" class="absolute hidden bg-white shadow-lg rounded-md py-2 w-56 z-20 border border-slate-100 top-full mt-2 right-0">
                    <a href="overseas-prices.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">æµ·å¤–ä¾¡æ ¼</a>
                    <a href="market-graphs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">ç›¸å ´ã‚°ãƒ©ãƒ•</a>
                    <a href="market-prices-logs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">ç›¸å ´ãƒ­ã‚°</a>
                </div>
            </div>

            <!-- éå»ãƒ‡ãƒ¼ã‚¿ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ (ã‚¯ãƒªãƒƒã‚¯å¼) -->
            <div class="relative js-dropdown">
                <button data-dropdown-toggle="pastDataDropdown" class="text-slate-600 hover:text-blue-600 font-semibold flex items-center">
                    éå»ãƒ‡ãƒ¼ã‚¿
                     <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="pastDataDropdown" class="absolute hidden bg-white shadow-lg rounded-md py-2 w-56 z-20 border border-slate-100 top-full mt-2 right-0">
                    <a href="../past-data/market-graphs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">ç›¸å ´ã‚°ãƒ©ãƒ•</a>
                    <a href="../past-data/market-prices-logs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">ç›¸å ´ãƒ­ã‚°</a>
                </div>
            </div>
        </nav>
        <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
        <button id="mobile-menu-button" class="block md:hidden text-slate-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
        </button>
    </div>
    <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-200">
        <a href="../2025/index.html" class="block px-6 py-3 text-slate-600 hover:bg-blue-50 font-semibold">ãƒ›ãƒ¼ãƒ </a>
        <details class="w-full">
            <summary class="px-6 py-3 text-slate-600 hover:bg-blue-50 font-semibold flex justify-between items-center cursor-pointer">
                <span>iPhone 17</span>
                <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="bg-slate-50">
                <a href="overseas-prices.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">æµ·å¤–ä¾¡æ ¼</a>
                <a href="market-graphs.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">ç›¸å ´ã‚°ãƒ©ãƒ•</a>
                <a href="market-prices-logs.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">ç›¸å ´ãƒ­ã‚°</a>
            </div>
        </details>
         <details class="w-full">
            <summary class="px-6 py-3 text-slate-600 hover:bg-blue-50 font-semibold flex justify-between items-center cursor-pointer">
                <span>éå»ãƒ‡ãƒ¼ã‚¿</span>
                <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </summary>
            <div class="bg-slate-50">
               <a href="../past-data/market-graphs.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">ç›¸å ´ã‚°ãƒ©ãƒ•</a>
               <a href="../past-data/market-prices-logs.html" class="block pl-10 pr-6 py-3 text-sm text-slate-700 hover:bg-blue-100">ç›¸å ´ãƒ­ã‚°</a>
            </div>
        </details>
    </div>
</header>

<main class="container mx-auto px-6 py-8 md:py-12">
    <h1 class="text-3xl font-bold text-slate-800 mb-6">æµ·å¤–ä¾¡æ ¼æ¯”è¼ƒ</h1>

    <div class="bg-white p-4 rounded-lg shadow-sm mb-8">
        <div id="model-selector" class="mb-2 flex flex-wrap justify-center gap-2 border-b pb-2"></div>
        <div id="capacity-selector" class="flex flex-wrap justify-center gap-2 pt-2"></div>
    </div>

    <div class="mb-10">
        <h2 class="text-2xl font-semibold text-slate-700 mb-4">
            å®Ÿè³ªä¾¡æ ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            <span class="block text-lg text-slate-500 font-normal">(<span id="ranking-model-name"></span> <span id="ranking-capacity-name"></span>)</span>
        </h2>
        <div id="ranking-container" class="bg-white p-4 sm:p-6 rounded-lg shadow-md min-h-[100px] relative">
            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ -->
            <div id="loader" class="absolute inset-0 flex justify-center items-center bg-white bg-opacity-75">
                <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <p class="text-center p-8 text-slate-500">æ©Ÿç¨®ã¨å®¹é‡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>

    <div id="cards-section" class="mb-10 hidden">
        <h2 class="text-2xl font-semibold text-slate-700 mb-4">å›½åˆ¥ è©³ç´°ãƒ‡ãƒ¼ã‚¿</h2>
        <div id="country-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 min-h-[100px]"></div>
    </div>
</main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="bg-slate-800 text-white mt-auto">
        <div class="container mx-auto px-6 py-8 text-center">
            <p>&copy; 2025 iPhoneç›¸å ´. All rights reserved.</p>
        </div>
    </footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=1368139795&single=true&output=csv';

let allParsedData = [];
let modelCapacityMap = {};

function parsePrice(str) {
    if(!str||typeof str!=='string') return null;
    const n=parseFloat(str.replace(/[^0-9.]/g,''));
    return isNaN(n)?null:n;
}
function formatPrice(n){ return n===null?'N/A':'Â¥'+Math.round(n).toLocaleString(); }
// æ—¥æœ¬ãŒãŠå¾—(æµ·å¤–ãŒé«˜ã„) > 0 = green, æµ·å¤–ãŒãŠå¾—(æµ·å¤–ãŒå®‰ã„) < 0 = red
function getDiffColor(diff){ if(diff===null)return 'text-slate-500'; if(diff<0)return 'text-red-600'; if(diff>0)return 'text-green-600'; return 'text-slate-500'; }

function formatExchangeRate(rateStr) {
    if (!rateStr) return 'N/A';
    const rate = parseFloat(rateStr);
    if (isNaN(rate)) return 'N/A';

    if (rate >= 1) {
        return rate.toFixed(2);
    } else {
        return rate.toFixed(3);
    }
}

function renderContent(model, capacity) {
    const rankingContainer = document.getElementById('ranking-container');
    const cardsContainer = document.getElementById('country-cards-container');
    const cardsSection = document.getElementById('cards-section');
    document.getElementById('ranking-model-name').textContent = model;
    document.getElementById('ranking-capacity-name').textContent = capacity;

    const filteredData = allParsedData.filter(item => item.model === model && item.capacity === capacity);

    if (filteredData.length === 0) {
        rankingContainer.innerHTML = '<p class="text-center p-8 text-slate-500">ã“ã®æ¡ä»¶ã®è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        cardsContainer.innerHTML = '';
        cardsSection.classList.add('hidden');
        return;
    }

    // ä¸­å›½ã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡ã‹ã‚‰é™¤å¤–
    const chinaData = filteredData.find(item => item.country === 'ä¸­å›½');
    const otherCountriesData = filteredData.filter(item => item.country !== 'ä¸­å›½');

    // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
    const rankingData = [...otherCountriesData].sort((a, b) => a.price - b.price);
    rankingContainer.innerHTML = '';
    const ol = document.createElement('ol');
    ol.className = 'space-y-4';
    rankingData.forEach((item, index) => {
        const li = document.createElement('li');
        const rank = index + 1;

        let bgColor = 'bg-slate-50'; // Default color
        let rankColor = 'text-slate-500';

        if (rank === 1) {
            bgColor = 'bg-yellow-100';
            rankColor = 'text-yellow-600';
        } else if (rank === 2) {
            bgColor = 'bg-slate-200';
            rankColor = 'text-slate-600';
        } else if (rank === 3) {
            bgColor = 'bg-orange-100';
            rankColor = 'text-orange-600';
        }

        // 4ä½ä»¥ä¸‹ã§æ—¥æœ¬ã®å ´åˆã«èƒŒæ™¯è‰²ã‚’ä¸Šæ›¸ã
        if (item.country === 'æ—¥æœ¬' && rank >= 4) {
            bgColor = 'bg-red-100';
        }

        li.className = `flex items-center justify-between p-3 rounded-md ${bgColor}`;
        li.innerHTML = `
            <div class="flex items-center min-w-0 mr-2">
                <span class="text-xl font-bold w-8 text-center flex-shrink-0 ${rankColor}">${rank}</span>
                <span class="ml-2 sm:ml-4 text-slate-800 font-semibold text-base sm:text-lg truncate">${item.flag || ''} ${item.country}</span>
            </div>
            <div class="text-right flex-shrink-0">
                <span class="text-base sm:text-lg font-bold text-slate-800">${formatPrice(item.price)}</span>
            </div>`;
        ol.appendChild(li);
    });

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æœ€ä¸‹éƒ¨ã«ä¸­å›½ã‚’è¿½åŠ 
    if (chinaData) {
        const li = document.createElement('li');
        li.className = `flex items-center justify-between p-3 rounded-md bg-slate-50`; // 4ä½ä»¥ä¸‹ã¨åŒæ§˜ã®è¡¨ç¤º
        li.innerHTML = `
            <div class="flex items-center min-w-0 mr-2">
                <span class="text-xl font-bold w-8 text-center flex-shrink-0 text-slate-500">-</span>
                <span class="ml-2 sm:ml-4 text-slate-800 font-semibold text-base sm:text-lg truncate">${chinaData.flag || ''} ${chinaData.country}</span>
            </div>
            <div class="text-right flex-shrink-0">
                <span class="text-base sm:text-lg font-bold text-slate-800">${formatPrice(chinaData.price)}</span>
            </div>`;
        ol.appendChild(li);
    }
    rankingContainer.appendChild(ol);

    // --- å›½åˆ¥ã‚«ãƒ¼ãƒ‰ ---
    cardsSection.classList.remove('hidden');
    cardsContainer.innerHTML = '';

    // ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºé †ã‚’å®šç¾©: æ—¥æœ¬ > ãƒ©ãƒ³ã‚­ãƒ³ã‚°é † > ä¸­å›½
    const rankedCountryNames = rankingData.map(item => item.country);
    const displayOrder = ['æ—¥æœ¬', ...rankedCountryNames.filter(name => name !== 'æ—¥æœ¬')];
    if (chinaData) {
        displayOrder.push('ä¸­å›½');
    }

    displayOrder.forEach(cn => {
        const item = filteredData.find(d => d.country === cn);
        if (!item) return;

        const card = document.createElement('div');
        card.className = 'bg-white p-5 rounded-lg shadow-md flex flex-col';
        const isJapan = item.country === 'æ—¥æœ¬';
        const cardTitle = `${item.flag || ''} ${item.country}`;

        const section1HTML = isJapan ?
            `<div class="col-span-3">
                <p class="text-xs text-slate-500">ç¨ç‡</p>
                <p class="font-semibold text-sm text-slate-700">${item.taxRate !== null ? item.taxRate + '%' : 'N/A'}</p>
            </div>` :
            `<div>
                <p class="text-xs text-slate-500">ç‚ºæ›¿</p>
                <p class="font-semibold text-sm text-slate-700">${item.exchangeRate ? formatExchangeRate(item.exchangeRate) + 'å††' : 'N/A'}</p>
            </div>
            <div>
                <p class="text-xs text-slate-500">ç¨ç‡</p>
                <p class="font-semibold text-sm text-slate-700">${item.taxRate !== null ? item.taxRate + '%' : 'N/A'}</p>
            </div>
            <div>
                <p class="text-xs text-slate-500">ç¾åœ°ä¾¡æ ¼</p>
                <p class="font-semibold text-sm text-slate-700">${item.currencySymbol || ''}${item.localPrice ? Number(item.localPrice).toLocaleString() : 'N/A'}</p>
            </div>`;

        const section2HTML = isJapan ?
            `<div class="flex justify-between items-center"><dt class="text-slate-600">æ—¥æœ¬å††ä¾¡æ ¼(ç¨è¾¼)</dt><dd class="font-semibold text-slate-800 text-base">${formatPrice(item.japanPriceTaxIn)}</dd></div>
             <div class="flex justify-between items-center"><dt class="text-slate-600">æ—¥æœ¬å††ä¾¡æ ¼(ç¨æŠœ)</dt><dd class="font-bold text-blue-600 text-base">${formatPrice(item.japanPrice)}</dd></div>` :
            `<div class="flex justify-between items-center"><dt class="text-slate-600">æ—¥æœ¬å††æ›ç®—ä¾¡æ ¼</dt><dd class="font-bold text-blue-600 text-base">${formatPrice(item.price)}</dd></div>
             <div class="flex justify-between items-center"><dt class="text-slate-600">æ—¥æœ¬ä¾¡æ ¼(ç¨æŠœ)</dt><dd class="font-semibold text-slate-800 text-base">${formatPrice(item.japanPrice)}</dd></div>`;

        let section3HTML;
        if (item.country === 'ä¸­å›½') {
            section3HTML = `<p class="text-center text-sm font-semibold text-slate-600">æ©Ÿèƒ½ã«åˆ¶é™ãŒã‚ã‚‹ãŸã‚é™¤å¤–ã—ã¦ã„ã¾ã™</p>`;
        } else if (isJapan) {
            section3HTML = `<p class="text-xs text-slate-500 text-center">â€»ã“ã¡ã‚‰ã¯å‚è€ƒä¾¡æ ¼ã§ã™ã€‚</p>`;
        } else {
            const diff = item.price - (item.japanPrice || 0);
            const diffText = diff === null ? '' : (diff >= 0 ? `+${Math.round(diff).toLocaleString()}å††` : `${Math.round(diff).toLocaleString()}å††`);
            const japanDisplayName = `${rankingData.find(c => c.country === 'æ—¥æœ¬')?.flag || 'ğŸ‡¯ğŸ‡µ'} æ—¥æœ¬`;
            const otokuText = diff === null ? '' : (diff < 0 ? `${cardTitle}ã®ã»ã†ãŒãŠå¾—` : `${japanDisplayName}ã®ã»ã†ãŒãŠå¾—`);
            section3HTML = `<div class="w-full">
                <dl class="text-sm">
                  <div class="flex justify-between items-center"><dt class="font-semibold text-slate-600">å·®é¡</dt><dd class="font-bold text-xl ${getDiffColor(diff)}">${diffText}</dd></div>
                </dl>
                <p class="text-center mt-4 text-base font-bold ${getDiffColor(diff)}">${otokuText}ï¼</p>
            </div>`;
        }

        card.innerHTML = `
            <h3 class="text-xl font-bold text-slate-800 mb-4">${cardTitle}</h3>
            <div class="grid grid-cols-3 gap-2 text-center border-y py-3">${section1HTML}</div>
            <dl class="space-y-3 text-sm py-3 border-b mb-3">${section2HTML}</dl>
            <div class="mt-auto flex-grow flex flex-col items-center justify-center">${section3HTML}</div>
        `;
        cardsContainer.appendChild(card);
    });
}


function selectModel(model, btnElement) {
    document.querySelectorAll('#model-selector button').forEach(b => b.classList.remove('active-btn'));
    btnElement.classList.add('active-btn');

    document.getElementById('ranking-model-name').textContent = model;
    document.getElementById('ranking-capacity-name').textContent = '';
    document.getElementById('ranking-container').innerHTML = '<p class="text-center p-8 text-slate-500">å®¹é‡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
    document.getElementById('cards-section').classList.add('hidden');

    const capacityContainer = document.getElementById('capacity-selector');
    capacityContainer.classList.add('visible');
    capacityContainer.innerHTML = '';
    const capacities = modelCapacityMap[model] || [];
    capacities.forEach(cap => {
        const btn = document.createElement('button');
        btn.textContent = cap;
        btn.className = 'capacity-selector-btn px-4 py-2 text-xs font-semibold rounded-md transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200 border';
        btn.addEventListener('click', () => {
            document.querySelectorAll('.capacity-selector-btn').forEach(b => b.classList.remove('active-btn'));
            btn.classList.add('active-btn');
            renderContent(model, cap);
        });
        capacityContainer.appendChild(btn);
    });
}

async function fetchWithRetry(url, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
            }
            return response; // Success
        } catch (error) {
            console.error(`Attempt ${i + 1} failed:`, error.message);
            if (i === retries - 1) {
                throw error;
            }
            await new Promise(res => setTimeout(res, delay));
        }
    }
}

async function initializePage() {
    const loader = document.getElementById('loader');
    const modelSelector = document.getElementById('model-selector');
    const rankingContainer = document.getElementById('ranking-container');

    const showError = (msg) => {
        rankingContainer.innerHTML = `<p class="text-center p-8 text-red-500">${msg}</p>`;
        if(loader) loader.style.display = 'none';
    };

    try {
        const response = await fetchWithRetry(CSV_URL);
        const csvText = await response.text();
        const rows = csvText.trim().split(/\r?\n/).map(r => r.split(',')).filter(r => r.length > 1 && r.join('').trim() !== '');

        if (rows.length < 4) throw new Error('CSVãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™ã€‚');

        const header = rows[0];
        const capacityHeader = rows[1];

        const columnMap = {};
        let currentModel = null;
        // Correctly loop over price columns C to N (indices 2 to 13)
        for (let i = 2; i <= 13; i++) {
            const modelCell = header[i] ? header[i].trim() : '';
            const capacityCell = capacityHeader[i] ? capacityHeader[i].trim() : '';
            if (modelCell) currentModel = modelCell;
            if (currentModel && (capacityCell.endsWith('GB') || capacityCell.endsWith('TB'))) {
                columnMap[i] = { model: currentModel, capacity: capacityCell };
                if (!modelCapacityMap[currentModel]) modelCapacityMap[currentModel] = [];
                if (!modelCapacityMap[currentModel].includes(capacityCell)) modelCapacityMap[currentModel].push(capacityCell);
            }
        }

        allParsedData = [];
        const dataRows = rows.slice(2);

        const japanTaxInRow = dataRows.find(r => r[1] && r[1].includes('æ—¥æœ¬ä¾¡æ ¼(ç¨è¾¼)'));
        const japanTaxExRow = dataRows.find(r => r[1] && r[1].includes('æ—¥æœ¬ä¾¡æ ¼(ç¨æŠœ)'));
        if (!japanTaxExRow || !japanTaxInRow) throw new Error('æ—¥æœ¬ã®ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');

        const japanTaxRate = parsePrice(japanTaxInRow[15]);
        const japanFlag = japanTaxInRow[29] ? japanTaxInRow[29].trim() : 'ğŸ‡¯ğŸ‡µ';
        const japanCurrencySymbol = japanTaxInRow[30] ? japanTaxInRow[30].trim() : 'Â¥';

        const japanDataStore = {};
        for (const colIndex in columnMap) {
            const { model, capacity } = columnMap[colIndex];
            const taxIn = parsePrice(japanTaxInRow[colIndex]);
            const taxEx = parsePrice(japanTaxExRow[colIndex]);
            japanDataStore[`${model}_${capacity}`] = { taxIn, taxEx };

            if (taxEx !== null) {
                allParsedData.push({
                    country: 'æ—¥æœ¬', model, capacity,
                    price: taxEx,
                    japanPrice: taxEx,
                    japanPriceTaxIn: taxIn,
                    exchangeRate: null,
                    taxRate: japanTaxRate,
                    localPrice: taxIn,
                    flag: japanFlag,
                    currencySymbol: japanCurrencySymbol
                });
            }
        }

        dataRows.forEach(row => {
            const dataType = row[1] ? row[1].trim() : '';
            if (!dataType.includes('ä¾¡æ ¼(æ—¥æœ¬å††æ›ç®—)')) {
                return;
            }

            let countryName = row[0] ? row[0].trim() : '';
            if (!countryName) return;

            const exchangeRate = row[14] ? row[14].trim() : null;
            const taxRate = parsePrice(row[15]);
            const flag = row[29] ? row[29].trim() : '';
            const currencySymbol = row[30] ? row[30].trim() : '';

            for (const colIndex in columnMap) {
                const { model, capacity } = columnMap[colIndex];
                const overseasPriceYen = parsePrice(row[colIndex]);

                const localPriceCol = parseInt(colIndex) + 15;
                const localPrice = row[localPriceCol] ? row[localPriceCol].trim() : null;

                const japanPrices = japanDataStore[`${model}_${capacity}`];

                if (overseasPriceYen !== null && japanPrices) {
                    allParsedData.push({
                        country: countryName, model, capacity,
                        price: overseasPriceYen,
                        japanPrice: japanPrices.taxEx,
                        japanPriceTaxIn: japanPrices.taxIn,
                        exchangeRate, taxRate, localPrice,
                        flag, currencySymbol
                    });
                }
            }
        });

        Object.keys(modelCapacityMap).forEach(model => {
            const btn = document.createElement('button');
            btn.textContent = model;
            btn.className = 'model-selector-btn w-[calc(50%-0.25rem)] sm:w-auto px-2 sm:px-4 py-2 text-[11px] sm:text-sm text-center font-semibold rounded-md transition-colors bg-white text-slate-700 shadow-sm hover:bg-slate-100 border whitespace-nowrap';
            btn.addEventListener('click', () => selectModel(model, btn));
            modelSelector.appendChild(btn);
        });

        if (modelSelector.children.length === 0) {
            rankingContainer.innerHTML = '<p class="text-center p-8 text-slate-500">è¡¨ç¤ºã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        } else {
             // Hide the initial message once data is ready
            const initialMessage = rankingContainer.querySelector('p');
            if(initialMessage) initialMessage.style.display = 'none';
        }
        
        loader.style.display = 'none';

    } catch (e) {
        console.error(e);
        let errorMessage = `ãƒ‡ãƒ¼ã‚¿å–å¾—ã¾ãŸã¯å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ã‚¨ãƒ©ãƒ¼: ${e.message}`;
        if (e.message.includes('408') || e.message.includes('server error')) {
            errorMessage = `ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ã‹ã€å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`;
        } else if (e.message.includes('Failed to fetch')) {
            errorMessage = `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
        }
        showError(errorMessage);
    }
}


function setupEventListeners() {
    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
    const dropdownToggles = document.querySelectorAll('[data-dropdown-toggle]');
    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function(event) {
            event.stopPropagation();
            const dropdownId = this.getAttribute('data-dropdown-toggle');
            const dropdownMenu = document.getElementById(dropdownId);

            document.querySelectorAll('.js-dropdown [id$="Dropdown"]').forEach(menu => {
                if (menu.id !== dropdownId) {
                    menu.classList.add('hidden');
                }
            });
            dropdownMenu.classList.toggle('hidden');
        });
    });

    // ä»–ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
    window.addEventListener('click', function(event) {
        if (!event.target.closest('.js-dropdown')) {
            document.querySelectorAll('.js-dropdown [id$="Dropdown"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ¶å¾¡
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenuButton && mobileMenu) {
        mobileMenuButton.addEventListener('click', (event) => {
            event.stopPropagation();
            mobileMenu.classList.toggle('hidden');
        });
    }

    // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³
    const detailsElements = document.querySelectorAll('#mobile-menu details');
    detailsElements.forEach(details => {
        details.addEventListener('toggle', function() {
            if (this.open) {
                // ä»–ã®é–‹ã„ã¦ã„ã‚‹detailsã‚’é–‰ã˜ã‚‹
                detailsElements.forEach(otherDetails => {
                    if (otherDetails !== this && otherDetails.open) {
                        otherDetails.removeAttribute('open');
                    }
                });
            }
        });
    });
}


document.addEventListener('DOMContentLoaded', () => {
    initializePage();
    setupEventListeners();
});

</script>
</body>
</html>
