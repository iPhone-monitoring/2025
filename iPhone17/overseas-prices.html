<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海外価格 - iPhone相場</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        .active-btn { 
            background-color:#2563eb !important; 
            color:white !important; 
            border-color: #2563eb !important;
            box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1); 
        }
        #capacity-selector:not(.visible){ display:none; }
        summary::-webkit-details-marker {
            display: none;
        }
        summary {
            list-style: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- ヘッダー -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600">iPhone相場</a>
            <nav class="hidden md:flex items-center space-x-6">
                <!-- iPhone 17 ドロップダウン (クリック式) -->
                <div class="relative js-dropdown">
                    <button data-dropdown-toggle="iphone17Dropdown" class="text-slate-600 hover:text-blue-600 font-semibold flex items-center">
                        iPhone 17
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="iphone17Dropdown" class="absolute hidden bg-white shadow-lg rounded-md py-2 w-56 z-20 border border-slate-100 top-full mt-2 right-0">
                        <a href="iPhone17/overseas-prices.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">海外価格</a>
                        <a href="iPhone17/market-graphs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場グラフ</a>
                        <a href="iPhone17/market-price-logs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場ログ</a>
                    </div>
                </div>

                <!-- 過去データ ドロップダウン (クリック式) -->
                <div class="relative js-dropdown">
                    <button data-dropdown-toggle="pastDataDropdown" class="text-slate-600 hover:text-blue-600 font-semibold flex items-center">
                        過去データ
                         <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="pastDataDropdown" class="absolute hidden bg-white shadow-lg rounded-md py-2 w-56 z-20 border border-slate-100 top-full mt-2 right-0">
                        <a href="past-data/market-graphs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場グラフ</a>
                        <a href="past-data/market-price-logs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場ログ</a>
                    </div>
                </div>
            </nav>
            <button class="block md:hidden text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>
    </header>

<main class="container mx-auto px-6 py-8 md:py-12">
<h1 class="text-3xl font-bold text-slate-800 mb-2">海外価格 リアルタイム比較</h1>
<p class="text-slate-600 mb-6">このデータはDropboxのCSVファイルから自動更新されます。</p>

<div class="bg-white p-4 rounded-lg shadow-sm mb-8">
    <div id="model-selector" class="mb-4 flex flex-wrap justify-center gap-2 border-b pb-4"></div>
    <div id="capacity-selector" class="flex flex-wrap justify-center gap-2 pt-4"></div>
</div>

<div class="mb-10">
    <h2 class="text-2xl font-semibold text-slate-700 mb-4">
        価格の安い国ランキング (<span id="ranking-model-name"></span> <span id="ranking-capacity-name"></span>)
    </h2>
    <div id="ranking-container" class="bg-white p-4 sm:p-6 rounded-lg shadow-md min-h-[100px]">
        <p class="text-center p-8 text-slate-500">機種と容量を選択してください。</p>
    </div>
</div>

<div id="cards-section" class="mb-10 hidden">
    <h2 class="text-2xl font-semibold text-slate-700 mb-4">国別 詳細データ</h2>
    <div id="country-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 min-h-[100px]"></div>
</div>
</main>

    <!-- フッター -->
    <footer class="bg-slate-800 text-white mt-auto">
        <div class="container mx-auto px-6 py-8 text-center">
            <p>&copy; 2025 iPhone相場. All rights reserved.</p>
        </div>
    </footer>

<script>
const DROPBOX_CSV_URL = 'https://www.dropbox.com/scl/fi/ls2rcgkx68xqx31mgqs40/overseas-prices.csv?rlkey=wddtnl73jgqgbwtwcw0s7wagx&dl=1';
const PROXY_URL = `https://corsproxy.io/?${encodeURIComponent(DROPBOX_CSV_URL)}`;

let allParsedData = [];
let modelCapacityMap = {};
// 新しい国をCSVに追加した場合、ここに国名と国旗を追加すれば自動で対応します。
const FLAG_MAP = {'日本': '🇯🇵', 'アメリカ': '🇺🇸', '香港': '🇭🇰', '韓国': '🇰🇷'};

function parsePrice(str) {
    if(!str||typeof str!=='string') return null;
    const n=parseFloat(str.replace(/[^0-9.]/g,''));
    return isNaN(n)?null:n;
}
function formatPrice(n){ return n===null?'N/A':'¥'+Math.round(n).toLocaleString(); }
// 日本がお得(海外が高い) > 0 = green, 海外がお得(海外が安い) < 0 = red
function getDiffColor(diff){ if(diff===null)return 'text-slate-500'; if(diff<0)return 'text-red-600'; if(diff>0)return 'text-green-600'; return 'text-slate-500'; }

function renderContent(model,capacity){
    const rankingContainer=document.getElementById('ranking-container');
    const cardsContainer=document.getElementById('country-cards-container');
    const cardsSection=document.getElementById('cards-section');
    document.getElementById('ranking-model-name').textContent=model;
    document.getElementById('ranking-capacity-name').textContent=capacity;

    const filteredData=allParsedData.filter(item=>item.model===model && item.capacity===capacity);

    if(filteredData.length===0){
        rankingContainer.innerHTML='<p class="text-center p-8 text-slate-500">この条件の表示データがありません。</p>';
        cardsContainer.innerHTML='';
        cardsSection.classList.add('hidden');
        return;
    }

    // --- ランキング ---
    const rankingData=[...filteredData].sort((a,b)=>a.price - b.price);
    rankingContainer.innerHTML='';
    const ol=document.createElement('ol'); ol.className='space-y-4';
    rankingData.forEach((item,index)=>{
        const li=document.createElement('li');
        const rank=index+1;
        let bgColor='bg-slate-50';
        let rankColor='text-slate-500';
        if(rank===1) { bgColor='bg-yellow-100'; rankColor='text-yellow-600'; }
        if(rank===2) { bgColor='bg-slate-200'; rankColor='text-slate-600'; }
        if(rank===3) { bgColor='bg-orange-100'; rankColor='text-orange-600'; }
        
        li.className=`flex items-center justify-between p-3 rounded-md ${bgColor}`;
        li.innerHTML=`
            <div class="flex items-center">
                <span class="text-xl font-bold w-8 text-center ${rankColor}">${rank}</span>
                <span class="ml-4 text-slate-800 font-semibold text-lg">${FLAG_MAP[item.country] || ''} ${item.country}</span>
            </div>
            <div class="text-right">
                <span class="text-lg font-bold text-slate-800">${formatPrice(item.price)}</span>
            </div>`;
        ol.appendChild(li);
    });
    rankingContainer.appendChild(ol);

    // --- 国別カード ---
    cardsSection.classList.remove('hidden');
    cardsContainer.innerHTML='';
    
    const rankedCountryNames = rankingData.map(item => item.country);
    const displayOrder = ['日本', ...rankedCountryNames.filter(name => name !== '日本')];
    
    displayOrder.forEach(cn=>{
        const item=filteredData.find(d=>d.country===cn);
        if(!item) return;

        const card=document.createElement('div'); card.className='bg-white p-5 rounded-lg shadow-md flex flex-col';
        const cardTitle = `${FLAG_MAP[item.country] || ''} ${item.country}`;

        if(item.country==='日本'){
            card.innerHTML=`
                <h3 class="text-xl font-bold text-slate-800 mb-4">${cardTitle}</h3>
                <div class="grid grid-cols-3 gap-2 text-center py-3">
                    <div class="col-span-3">
                        <p class="text-xs text-slate-500">税率</p>
                        <p class="font-semibold text-sm text-slate-700">${item.taxRate !== null ? item.taxRate + '%' : 'N/A'}</p>
                    </div>
                </div>
                <dl class="space-y-3 text-sm border-y py-3 my-3">
                    <div class="flex justify-between items-center"><dt class="text-slate-600">日本円価格(税込)</dt><dd class="font-semibold text-slate-800 text-base">${formatPrice(item.japanPriceTaxIn)}</dd></div>
                    <div class="flex justify-between items-center"><dt class="text-slate-600">日本円価格(税抜)</dt><dd class="font-bold text-blue-600 text-base">${formatPrice(item.japanPrice)}</dd></div>
                </dl>
                <div class="mt-auto">
                    <p class="text-xs text-slate-500">※ランキング比較用の価格は税抜です。</p>
                </div>
            `;
        } else {
            const diff=item.price - (item.japanPrice||0);
            const diffText=diff>=0?`+${Math.round(diff).toLocaleString()}円`:`${Math.round(diff).toLocaleString()}円`;
            const japanDisplayName = `${FLAG_MAP['日本'] || ''} 日本`;
            const otokuText=diff<0?`${cardTitle}のほうがお得`:`${japanDisplayName}のほうがお得`;
            const formattedLocalPrice = item.localPrice ? Number(item.localPrice).toLocaleString() : 'N/A';
            const currencySymbol = {'アメリカ':'$','香港':'HK$','韓国':'₩'}[item.country] || '';

            card.innerHTML=`
                <h3 class="text-xl font-bold text-slate-800 mb-4">${cardTitle}</h3>
                <div class="grid grid-cols-3 gap-2 text-center py-3">
                    <div>
                        <p class="text-xs text-slate-500">為替</p>
                        <p class="font-semibold text-sm text-slate-700">${item.exchangeRate ? item.exchangeRate + '円' : 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500">税率</p>
                        <p class="font-semibold text-sm text-slate-700">${item.taxRate !== null ? item.taxRate + '%' : 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500">現地価格</p>
                        <p class="font-semibold text-sm text-slate-700">${currencySymbol}${formattedLocalPrice}</p>
                    </div>
                </div>
                <dl class="space-y-3 text-sm border-y py-3 my-3">
                    <div class="flex justify-between items-center"><dt class="text-slate-600">日本円換算価格</dt><dd class="font-bold text-blue-600 text-base">${formatPrice(item.price)}</dd></div>
                    <div class="flex justify-between items-center"><dt class="text-slate-600">日本価格(税抜)</dt><dd class="font-semibold text-slate-800 text-base">${formatPrice(item.japanPrice)}</dd></div>
                </dl>
                <div class="mt-auto">
                    <dl class="space-y-3 text-sm">
                        <div class="flex justify-between items-center"><dt class="font-semibold text-slate-600">差額</dt><dd class="font-bold text-xl ${getDiffColor(diff)}">${diffText}</dd></div>
                    </dl>
                    <p class="text-center mt-4 text-base font-bold ${getDiffColor(diff)}">${otokuText}！</p>
                </div>
            `;
        }
        cardsContainer.appendChild(card);
    });
}

function selectModel(model, btnElement) {
    document.querySelectorAll('#model-selector button').forEach(b => b.classList.remove('active-btn'));
    btnElement.classList.add('active-btn');
    
    document.getElementById('ranking-model-name').textContent = model;
    document.getElementById('ranking-capacity-name').textContent = '';
    document.getElementById('ranking-container').innerHTML = '<p class="text-center p-8 text-slate-500">容量を選択してください。</p>';
    document.getElementById('cards-section').classList.add('hidden');

    const capacityContainer = document.getElementById('capacity-selector');
    capacityContainer.classList.add('visible');
    capacityContainer.innerHTML = '';
    
    const capacities = modelCapacityMap[model] || [];
    capacities.forEach(cap => {
        const btn = document.createElement('button');
        btn.textContent = cap;
        btn.className = 'capacity-selector-btn px-3 py-1.5 text-xs font-semibold rounded-md transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200 border';
        btn.addEventListener('click', () => {
            document.querySelectorAll('.capacity-selector-btn').forEach(b => b.classList.remove('active-btn'));
            btn.classList.add('active-btn');
            renderContent(model, cap);
        });
        capacityContainer.appendChild(btn);
    });
}

async function initializePage(){
    const modelSelector=document.getElementById('model-selector');
    const showError=msg=>{ document.getElementById('ranking-container').innerHTML=`<p class="text-center p-8 text-red-500">${msg}</p>`; };

    try{
        const response=await fetch(PROXY_URL);
        if(!response.ok) throw new Error(`サーバーエラー: ${response.status}`);
        const csvText=await response.text();
        const rows=csvText.trim().replace(/\r/g,'').split('\n').map(r=>r.split(',')).filter(r=>r.length>1 && r.join('').trim()!=='');

        if (rows.length < 3) throw new Error('CSVデータが不正です。');

        const header = rows[0];
        const capacityHeader = rows[1];
        
        const columnMap = {}; 
        let currentModel = null;
        for (let i = 2; i <= 15; i++) { 
            const modelCell = header[i] ? header[i].trim() : '';
            const capacityCell = capacityHeader[i] ? capacityHeader[i].trim() : '';
            if (modelCell) currentModel = modelCell;
            if (currentModel && (capacityCell.endsWith('GB') || capacityCell.endsWith('TB'))) {
                columnMap[i] = { model: currentModel, capacity: capacityCell };
                if (!modelCapacityMap[currentModel]) modelCapacityMap[currentModel] = [];
                if (!modelCapacityMap[currentModel].includes(capacityCell)) modelCapacityMap[currentModel].push(capacityCell);
            }
        }
        
        allParsedData = [];
        const dataRows = rows.slice(2);
        const japanDataStore = {};

        const japanTaxInRow = dataRows.find(r => r[1] && r[1].includes('日本価格(税込)'));
        const japanTaxExRow = dataRows.find(r => r[1] && r[1].includes('日本価格(税抜)'));
        if (!japanTaxExRow || !japanTaxInRow) throw new Error('日本の価格データが見つかりません。');
        
        const japanTaxRate = parsePrice(japanTaxInRow[15]);

        for (const colIndex in columnMap) {
            const { model, capacity } = columnMap[colIndex];
            const taxIn = parsePrice(japanTaxInRow[colIndex]);
            const taxEx = parsePrice(japanTaxExRow[colIndex]);
            japanDataStore[`${model}_${capacity}`] = { taxIn, taxEx };
        }

        dataRows.forEach(row => {
            const displayName = row[0] ? row[0].trim() : '';
            const dataType = row[1] ? row[1].trim() : '';
            if (!displayName || !dataType) return;
            
            // 絵文字を無視して国名テキストのみを抽出
            const countryNameMatch = displayName.match(/[^\uD83C-\uDBFF\uDC00-\uDFFF\s].*/);
            const countryName = countryNameMatch ? countryNameMatch[0].trim() : '';
            if (!countryName) return;


            if (dataType.includes('日本価格(税込)')) {
                 for (const colIndex in columnMap) {
                    const { model, capacity } = columnMap[colIndex];
                    const prices = japanDataStore[`${model}_${capacity}`];
                    if (prices && prices.taxEx !== null) {
                         allParsedData.push({ 
                            country: '日本', model, capacity, 
                            price: prices.taxEx, 
                            japanPrice: prices.taxEx, 
                            japanPriceTaxIn: prices.taxIn,
                            exchangeRate: null, taxRate: japanTaxRate, localPrice: prices.taxIn 
                        });
                    }
                }
            } 
            else if (dataType.includes('価格(日本円換算)')) {
                const exchangeRate = row[14] ? row[14].trim() : null;
                const taxRate = parsePrice(row[15]);

                for (const colIndex in columnMap) {
                    const { model, capacity } = columnMap[colIndex];
                    const overseasPriceYen = parsePrice(row[colIndex]);
                    const localPriceCol = parseInt(colIndex) + 15;
                    const localPrice = row[localPriceCol] ? row[localPriceCol].trim() : null;
                    const japanPrices = japanDataStore[`${model}_${capacity}`];
                    
                    if (overseasPriceYen !== null && japanPrices) {
                        allParsedData.push({
                            country: countryName, model, capacity,
                            price: overseasPriceYen,
                            japanPrice: japanPrices.taxEx,
                            japanPriceTaxIn: japanPrices.taxIn,
                            exchangeRate, taxRate, localPrice
                        });
                    }
                }
            }
        });

        Object.keys(modelCapacityMap).forEach(model=>{
            const btn=document.createElement('button');
            btn.textContent=model;
            btn.className='model-selector-btn px-4 py-2 text-sm font-semibold rounded-md transition-colors bg-white text-slate-700 shadow-sm hover:bg-slate-100 border';
            btn.addEventListener('click',() => selectModel(model, btn));
            modelSelector.appendChild(btn);
        });

        if(modelSelector.children.length === 0) showError('表示できるモデルデータがありません。');

    }catch(e){
        console.error(e);
        showError(`データ取得または処理に失敗しました。<br>エラー: ${e.message}`);
    }
}

document.addEventListener('DOMContentLoaded', initializePage);

document.addEventListener('DOMContentLoaded', function() {
    const dropdownToggles = document.querySelectorAll('[data-dropdown-toggle]');
    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function(event) {
            event.stopPropagation();
            const dropdownId = this.getAttribute('data-dropdown-toggle');
            const dropdownMenu = document.getElementById(dropdownId);
            
            document.querySelectorAll('[id$="Dropdown"]').forEach(menu => {
                if (menu.id !== dropdownId) {
                    menu.classList.add('hidden');
                }
            });
            dropdownMenu.classList.toggle('hidden');
        });
    });
    window.addEventListener('click', function(event) {
        if (!event.target.closest('.js-dropdown')) {
            document.querySelectorAll('[id$="Dropdown"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });
});
</script>
</body>
</html>

