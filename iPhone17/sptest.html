<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>相場グラフ - iPhone相場</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:'Inter','Noto Sans JP',sans-serif; display:flex; flex-direction:column; min-height:100vh; background-color:#f1f5f9;}
main { flex-grow:1; }
button { cursor:pointer; }
.active-btn { background-color:#2563eb !important; color:white !important; border-color:#2563eb !important; }
</style>
</head>
<body>
<header class="bg-white shadow-md sticky top-0 z-10">
<div class="container mx-auto px-6 py-4">
<h1 class="text-2xl font-bold text-blue-600">iPhone相場</h1>
</div>
</header>

<main class="container mx-auto px-6 py-8">
<div id="model-selector" class="mb-4 flex flex-wrap gap-2"></div>
<div id="period-selector" class="mb-4 flex flex-wrap gap-2"></div>
<div class="bg-white p-4 rounded-lg shadow-md">
<canvas id="priceChart" class="min-h-[400px]"></canvas>
</div>
</main>

<footer class="bg-slate-800 text-white mt-auto py-4 text-center">
&copy; 2025 iPhone相場
</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=8162687&single=true&output=csv';

let allData = {};
let chartInstance = null;
const modelsOrder = ["iPhone 14","iPhone 14 Plus","iPhone 14 Pro","iPhone 14 Pro MAX","iPhone 15","iPhone 15 Plus","iPhone 15 Pro","iPhone 15 Pro MAX","iPhone 16","iPhone 16 Plus","iPhone 16 Pro","iPhone 16 Pro MAX"];
const periodsOrder = ["1週間","1ヶ月","3ヶ月","6ヶ月"];

function parsePrice(str) {
    if(!str) return null;
    str = str.replace(/,/g,'').replace(/"/g,'');
    const n = parseFloat(str);
    return isNaN(n) ? null : n;
}

function createChart(model, period) {
    const dataObj = allData[model]?.[period];
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();
    if(!dataObj) {
        chartInstance = new Chart(ctx,{type:'line',data:{datasets:[]},options:{plugins:{legend:{display:false}}}});
        return;
    }

    const colors = ['#3b82f6','#10b981','#f97316','#ec4899','#8b5cf6','#ef4444'];
    let colorIndex = 0;
    const datasets = [];
    Object.keys(dataObj.capacities).forEach(cap => {
        const color = colors[colorIndex % colors.length];
        datasets.push({
            label: cap,
            data: dataObj.capacities[cap].data.map((v,i)=>({x:i,y:v.price})),
            borderColor: color,
            borderWidth:2.5,
            fill:false,
            pointRadius:0,
            tension:0.1
        });
        // 定価
        const list_price = dataObj.capacities[cap].list_price;
        if(list_price){
            datasets.push({
                label: cap+' 定価',
                data: dataObj.capacities[cap].data.map((v,i)=>({x:i,y:list_price})),
                borderColor: color,
                borderWidth:1.5,
                borderDash:[5,5],
                pointRadius:0,
                fill:false
            });
        }
        colorIndex++;
    });

    chartInstance = new Chart(ctx,{
        type:'line',
        data:{datasets:datasets, labels:dataObj.data_labels},
        options:{
            responsive:true,
            plugins:{legend:{position:'bottom'}},
            scales:{
                x:{title:{display:true,text:'日付'}, ticks:{callback:(v,i)=>dataObj.data_labels[i]}},
                y:{title:{display:true,text:'価格 (円)'}}
            }
        }
    });
}

function selectPeriod(model, period, btn){
    document.querySelectorAll('#period-selector button').forEach(b=>b.classList.remove('active-btn'));
    btn.classList.add('active-btn');
    createChart(model, period);
}

function selectModel(model, btn){
    document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active-btn'));
    btn.classList.add('active-btn');
    const periodSelector = document.getElementById('period-selector');
    periodSelector.innerHTML = '';
    periodsOrder.forEach(p=>{
        if(allData[model][p]){
            const b = document.createElement('button');
            b.textContent = p;
            b.className='px-4 py-2 text-sm font-semibold rounded-md border bg-slate-100 hover:bg-slate-200 text-slate-600';
            b.addEventListener('click',()=>selectPeriod(model,p,b));
            periodSelector.appendChild(b);
        }
    });
}

async function initializePage(){
    const modelSelector = document.getElementById('model-selector');
    try{
        const res = await fetch(CSV_URL);
        if(!res.ok) throw new Error(res.statusText);
        const txt = await res.text();
        const rows = txt.trim().split(/\r?\n/).map(r=>r.split(','));
        // 1行目: 期間, 2行目: 機種, 3行目: 容量, 4行目: 定価
        const dataRows = rows.slice(4);
        for(let c=1;c<rows[0].length;c++){
            const period = rows[0][c].trim();
            const model = rows[1][c].trim();
            const capacity = rows[2][c].trim();
            const list_price = parsePrice(rows[3][c]);
            if(!allData[model]) allData[model]={};
            if(!allData[model][period]) allData[model][period]={capacities:{},data_labels:[]};
            if(!allData[model][period].capacities[capacity]) allData[model][period].capacities[capacity]={list_price:list_price,data:[]};
            // 左方向5行目から日付を取得
            const labels = [];
            const prices = [];
            for(let r=0;r<dataRows.length;r++){
                const dateLabel = dataRows[r][0].trim();
                const price = parsePrice(dataRows[r][c]);
                if(dateLabel && dateLabel.includes('/') && price!==null){
                    allData[model][period].capacities[capacity].data.push({date:dateLabel,price:price});
                    if(!allData[model][period].data_labels.includes(dateLabel)) allData[model][period].data_labels.push(dateLabel);
                }
            }
        }

        modelsOrder.forEach(m=>{
            if(allData[m]){
                const b = document.createElement('button');
                b.textContent=m;
                b.className='px-4 py-2 text-sm font-semibold rounded-md border bg-white text-slate-700 shadow-sm hover:bg-slate-100';
                b.addEventListener('click',()=>selectModel(m,b));
                modelSelector.appendChild(b);
            }
        });

    }catch(e){
        modelSelector.innerHTML='ネットワークエラーによりデータを取得できませんでした。<br>インターネット接続を確認してください。';
        console.error(e);
    }
}

document.addEventListener('DOMContentLoaded',initializePage);
</script>
</body>
</html>
