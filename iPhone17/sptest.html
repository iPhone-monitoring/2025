<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone相場グラフ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family:'Inter','Noto Sans JP',sans-serif; background:#f8fafc; color:#1e293b; }
  main { max-width:1000px; margin:2rem auto; }
  .btn { cursor:pointer; padding:0.5rem 1rem; margin:0.2rem; border-radius:0.375rem; border:1px solid #cbd5e1; background:#fff; color:#334155; font-weight:500; transition:0.2s; }
  .btn:hover { background:#f1f5f9; }
  .active { background:#2563eb; color:#fff; border-color:#2563eb; }
  #graph-container { min-height:400px; background:#fff; padding:1rem; border-radius:0.5rem; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
</style>
</head>
<body>
<main>
  <h1 class="text-2xl font-bold mb-4">iPhone過去相場グラフ</h1>
  <div id="model-selector" class="mb-4"></div>
  <div id="period-selector" class="mb-4"></div>
  <div id="graph-container"><p class="text-center text-slate-500 p-8">機種と期間を選択してください。</p></div>
</main>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=761980576&single=true&output=csv';

let csvRows = [];
let chartInstance = null;

// ボタン順序
const MODEL_ORDER = [
  'iPhone 14','iPhone 14 Plus','iPhone 14 Pro','iPhone 14 Pro MAX',
  'iPhone 15','iPhone 15 Plus','iPhone 15 Pro','iPhone 15 Pro MAX',
  'iPhone 16','iPhone 16 Plus','iPhone 16 Pro','iPhone 16 Pro MAX'
];

// CSV取得
async function fetchCSV() {
  const res = await fetch(CSV_URL);
  if (!res.ok) throw new Error('CSV取得失敗');
  const text = await res.text();
  csvRows = text.split(/\r?\n/).map(r=>r.split(','));
}

// 価格文字列を数字に変換
function parsePrice(str){ return str ? parseFloat(str.replace(/[^0-9]/g,'')) : null; }

// 機種ボタン作成
function createModelButtons() {
  const header = csvRows[1].slice(1).filter(v=>v); // 1行目は期間、2行目が機種
  const container = document.getElementById('model-selector');
  container.innerHTML = '';
  MODEL_ORDER.forEach(model=>{
    if(header.includes(model)){
      const btn=document.createElement('button');
      btn.textContent=model;
      btn.className='btn';
      btn.addEventListener('click',()=>selectModel(model, btn));
      container.appendChild(btn);
    }
  });
}

// 機種選択
function selectModel(model, btnElement) {
  document.querySelectorAll('#model-selector .btn').forEach(b=>b.classList.remove('active'));
  btnElement.classList.add('active');
  createPeriodButtons(model);
}

// 対象列取得（機種＋期間）
function getColumns(model, period){
  const cols=[];
  const header = csvRows[1];
  const periods = csvRows[0];
  for(let c=1;c<header.length;c++){
    if(header[c]===model && periods[c]===period) cols.push(c);
  }
  return cols;
}

// 期間ボタン作成
function createPeriodButtons(model){
  const periodSet=new Set();
  for(let c=1;c<csvRows[1].length;c++){
    if(csvRows[1][c]===model) periodSet.add(csvRows[0][c]);
  }
  const sorted=['1週間','1ヶ月','3ヶ月','6ヶ月'].filter(p=>periodSet.has(p));
  const container=document.getElementById('period-selector');
  container.innerHTML='';
  sorted.forEach(period=>{
    const btn=document.createElement('button');
    btn.textContent=period; btn.className='btn';
    btn.addEventListener('click',()=>drawChart(model, period));
    container.appendChild(btn);
  });
  document.getElementById('graph-container').innerHTML='<p class="text-center text-slate-500 p-8">期間を選択してください。</p>';
}

// 横軸列取得（左方向探索、数字でないセル）
function getDateColumn(targetCols){
  for(let c=Math.min(...targetCols)-1;c>=0;c--){
    for(let r=4;r<csvRows.length;r++){
      if(csvRows[r][c] && isNaN(csvRows[r][c])) return c;
    }
  }
  return null;
}

// グラフ描画（全容量同一グラフ）
function drawChart(model, period){
  const cols = getColumns(model, period);
  if(cols.length===0) return;
  const dateCol = getDateColumn(cols);
  if(dateCol===null){ alert('横軸日付が見つかりません'); return; }

  const datasets=[];
  const colors=['#3b82f6','#10b981','#f97316','#ec4899','#8b5cf6','#ef4444','#f59e0b','#0ea5e9'];

  cols.forEach((col,i)=>{
    const capacity=csvRows[2][col];
    const data=[];
    for(let r=4;r<csvRows.length;r++){
      const date=csvRows[r][dateCol];
      const price=parsePrice(csvRows[r][col]);
      if(date && price!==null) data.push({x:date, y:price});
      else if(!date) break;
    }
    const listPrice=parsePrice(csvRows[3][col]); // 4行目から定価取得

    datasets.push({
      label:capacity,
      data:data,
      borderColor:colors[i%colors.length],
      backgroundColor:colors[i%colors.length]+'33',
      borderWidth:2,
      tension:0.1,
      pointRadius:0, // ●消す
      fill:false
    });

    if(listPrice!==null){
      datasets.push({
        label:capacity+' 定価',
        data:data.map(d=>({x:d.x,y:listPrice})),
        borderColor:colors[i%colors.length],
        borderWidth:1.5,
        borderDash:[5,5],
        pointRadius:0,
        fill:false
      });
    }
  });

  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('priceChart') || (()=>{
    const container=document.getElementById('graph-container');
    container.innerHTML='<canvas id="priceChart"></canvas>';
    return document.getElementById('priceChart');
  })().getContext('2d');

  chartInstance = new Chart(ctx,{
    type:'line',
    data:{datasets:datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ type:'category', title:{display:true,text:'日付'} },
        y:{ title:{display:true,text:'価格(円)'},
            ticks:{ callback:v=>'¥'+v.toLocaleString() } }
      },
      plugins:{
        tooltip:{ callbacks:{ label:ctx=>ctx.dataset.label+': ¥'+ctx.parsed.y.toLocaleString() } }
      }
    }
  });
}

// 初期化
document.addEventListener('DOMContentLoaded',async()=>{
  await fetchCSV();
  createModelButtons();
});
</script>
</body>
</html>
