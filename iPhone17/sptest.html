<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>海外価格 - iPhone相場</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family:'Inter','Noto Sans JP',sans-serif; display:flex; flex-direction:column; min-height:100vh; }
main{flex-grow:1;}
.active-btn{ background-color:#2563eb !important; color:white !important; border-color:#2563eb !important; box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);}
#capacity-selector:not(.visible){display:none;}
summary::-webkit-details-marker {display:none;}
summary{list-style:none;}
details[open] summary svg{transform:rotate(180deg);}
</style>
</head>
<body class="bg-slate-50 text-slate-800">

<header class="bg-white shadow-md sticky top-0 z-10">
  <div class="container mx-auto px-6 py-4 flex justify-between items-center">
    <a href="../index.html" class="text-2xl font-bold text-blue-600">iPhone相場</a>
    <nav class="hidden md:flex items-center space-x-6">
      <a href="../index.html" class="text-slate-600 hover:text-blue-600 font-semibold">ホーム</a>
    </nav>
  </div>
</header>

<main class="container mx-auto px-6 py-8 md:py-12">
<h1 class="text-3xl font-bold text-slate-800 mb-6">海外価格比較</h1>

<div class="bg-white p-4 rounded-lg shadow-sm mb-8">
    <div id="model-selector" class="mb-4 flex flex-wrap justify-center gap-2 border-b pb-4"></div>
    <div id="capacity-selector" class="flex flex-wrap justify-center gap-2 pt-4"></div>
</div>

<div class="mb-10">
<h2 class="text-2xl font-semibold text-slate-700 mb-4">
    実質価格ランキング (<span id="ranking-model-name"></span> <span id="ranking-capacity-name"></span>)
</h2>
<div id="ranking-container" class="bg-white p-4 sm:p-6 rounded-lg shadow-md min-h-[100px]">
    <p class="text-center p-8 text-slate-500">機種と容量を選択してください。</p>
</div>
</div>

<div id="cards-section" class="mb-10 hidden">
<h2 class="text-2xl font-semibold text-slate-700 mb-4">国別 詳細データ</h2>
<div id="country-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 min-h-[100px]"></div>
</div>
</main>

<footer class="bg-slate-800 text-white mt-auto">
<div class="container mx-auto px-6 py-8 text-center">
<p>&copy; 2025 iPhone相場. All rights reserved.</p>
</div>
</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=1368139795&single=true&output=csv';

let allParsedData = [];
let modelCapacityMap = {};

function parsePrice(str){ if(!str||typeof str!=='string') return null; const n=parseFloat(str.replace(/[^0-9.]/g,'')); return isNaN(n)?null:n; }
function formatPrice(n){ return n===null?'N/A':'¥'+Math.round(n).toLocaleString(); }
function getDiffColor(diff){ if(diff===null)return 'text-slate-500'; if(diff<0)return 'text-red-600'; if(diff>0)return 'text-green-600'; return 'text-slate-500'; }

function renderContent(model,capacity){
    const rankingContainer=document.getElementById('ranking-container');
    const cardsContainer=document.getElementById('country-cards-container');
    const cardsSection=document.getElementById('cards-section');
    document.getElementById('ranking-model-name').textContent=model;
    document.getElementById('ranking-capacity-name').textContent=capacity;

    const filteredData=allParsedData.filter(item=>item.model===model && item.capacity===capacity);
    if(filteredData.length===0){
        rankingContainer.innerHTML='<p class="text-center p-8 text-slate-500">この条件の表示データがありません。</p>';
        cardsContainer.innerHTML='';
        cardsSection.classList.add('hidden');
        return;
    }

    const chinaData=filteredData.find(item=>item.country==='中国');
    const otherCountriesData=filteredData.filter(item=>item.country!=='中国');

    const rankingData=[...otherCountriesData].sort((a,b)=>a.price-b.price);
    rankingContainer.innerHTML='';
    const ol=document.createElement('ol'); ol.className='space-y-4';
    rankingData.forEach((item,index)=>{
        const li=document.createElement('li'); const rank=index+1;
        let bgColor='bg-slate-50'; let rankColor='text-slate-500';
        if(rank===1){bgColor='bg-yellow-100'; rankColor='text-yellow-600';}
        else if(rank===2){bgColor='bg-slate-200'; rankColor='text-slate-600';}
        else if(rank===3){bgColor='bg-orange-100'; rankColor='text-orange-600';}
        if(item.country==='日本' && rank>=4) bgColor='bg-red-100';
        li.className=`flex items-center justify-between p-3 rounded-md ${bgColor}`;
        li.innerHTML=`<div class="flex items-center">
            <span class="text-xl font-bold w-8 text-center ${rankColor}">${rank}</span>
            <span class="ml-4 text-slate-800 font-semibold text-lg">${item.flag||''} ${item.country}</span>
            </div>
            <div class="text-right"><span class="text-lg font-bold text-slate-800">${formatPrice(item.price)}</span></div>`;
        ol.appendChild(li);
    });
    if(chinaData){
        const li=document.createElement('li');
        li.className='flex items-center justify-between p-3 rounded-md bg-slate-50';
        li.innerHTML=`<div class="flex items-center">
            <span class="text-xl font-bold w-8 text-center text-slate-500">-</span>
            <span class="ml-4 text-slate-800 font-semibold text-lg">${chinaData.flag||''} 中国</span>
            </div>
            <div class="text-right"><span class="text-lg font-bold text-slate-800">${formatPrice(chinaData.price)}</span></div>`;
        ol.appendChild(li);
    }
    rankingContainer.appendChild(ol);

    cardsSection.classList.remove('hidden'); cardsContainer.innerHTML='';
    const rankedCountryNames=rankingData.map(item=>item.country);
    const displayOrder=['日本', ...rankedCountryNames.filter(name=>name!=='日本')]; if(chinaData) displayOrder.push('中国');
    displayOrder.forEach(cn=>{
        const item=filteredData.find(d=>d.country===cn); if(!item) return;
        const card=document.createElement('div'); card.className='bg-white p-5 rounded-lg shadow-md flex flex-col';
        const isJapan=item.country==='日本';
        const cardTitle=`${item.flag||''} ${item.country}`;
        const section1HTML=isJapan?`<div class="col-span-3">
            <p class="text-xs text-slate-500">税率</p>
            <p class="font-semibold text-sm text-slate-700">${item.taxRate!==null?item.taxRate+'%':'N/A'}</p>
            </div>`:`<div><p class="text-xs text-slate-500">為替</p><p class="font-semibold text-sm text-slate-700">${item.exchangeRate||'N/A'}</p></div>
            <div><p class="text-xs text-slate-500">税率</p><p class="font-semibold text-sm text-slate-700">${item.taxRate!==null?item.taxRate+'%':'N/A'}</p></div>
            <div><p class="text-xs text-slate-500">現地価格</p><p class="font-semibold text-sm text-slate-700">${item.currencySymbol||''}${item.localPrice||'N/A'}</p></div>`;
        const section2HTML=isJapan?`<div class="flex justify-between items-center"><dt class="text-slate-600">日本円価格(税込)</dt><dd class="font-semibold text-slate-800 text-base">${formatPrice(item.japanPriceTaxIn)}</dd></div>
            <div class="flex justify-between items-center"><dt class="text-slate-600">日本円価格(税抜)</dt><dd class="font-bold text-blue-600 text-base">${formatPrice(item.japanPrice)}</dd></div>`:`<div class="flex justify-between items-center"><dt class="text-slate-600">日本円換算価格</dt><dd class="font-bold text-blue-600 text-base">${formatPrice(item.price)}</dd></div>
            <div class="flex justify-between items-center"><dt class="text-slate-600">日本価格(税抜)</dt><dd class="font-semibold text-slate-800 text-base">${formatPrice(item.japanPrice)}</dd></div>`;
        let section3HTML;
        if(item.country==='中国') section3HTML=`<p class="text-center text-sm font-semibold text-slate-600">機能に制限があるため除外しています</p>`;
        else if(isJapan) section3HTML=`<p class="text-xs text-slate-500 text-center">※こちらは参考価格です。</p>`;
        else{
            const diff=item.price-(item.japanPrice||0);
            const diffText=diff===null?'':(diff>=0?`+${Math.round(diff).toLocaleString()}円`:`${Math.round(diff).toLocaleString()}円`);
            const japanDisplayName=`🇯🇵 日本`;
            const otokuText=diff===null?'':(diff<0?`${cardTitle}のほうがお得`:`${japanDisplayName}のほうがお得`);
            section3HTML=`<div class="w-full"><dl class="text-sm">
                <div class="flex justify-between items-center"><dt class="font-semibold text-slate-600">差額</dt><dd class="font-bold text-xl ${getDiffColor(diff)}">${diffText}</dd></div></dl>
                <p class="text-center mt-4 text-base font-bold ${getDiffColor(diff)}">${otokuText}！</p></div>`;
        }
        card.innerHTML=`<h3 class="text-xl font-bold text-slate-800 mb-4">${cardTitle}</h3>
            <div class="grid grid-cols-3 gap-2 text-center border-y py-3">${section1HTML}</div>
            <dl class="space-y-3 text-sm py-3 border-b mb-3">${section2HTML}</dl>
            <div class="mt-auto flex-grow flex flex-col items-center justify-center">${section3HTML}</div>`;
        cardsContainer.appendChild(card);
    });
}

function selectModel(model,btnElement){
    document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active-btn'));
    btnElement.classList.add('active-btn');
    document.getElementById('ranking-model-name').textContent=model;
    document.getElementById('ranking-capacity-name').textContent='';
    document.getElementById('ranking-container').innerHTML='<p class="text-center p-8 text-slate-500">容量を選択してください。</p>';
    document.getElementById('cards-section').classList.add('hidden');
    const capacityContainer=document.getElementById('capacity-selector');
    capacityContainer.classList.add('visible'); capacityContainer.innerHTML='';
    const capacities=modelCapacityMap[model]||[];
    capacities.forEach(cap=>{
        const btn=document.createElement('button'); btn.textContent=cap;
        btn.className='capacity-selector-btn px-3 py-1.5 text-xs font-semibold rounded-md transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200 border';
        btn.addEventListener('click',()=>{ document.querySelectorAll('.capacity-selector-btn').forEach(b=>b.classList.remove('active-btn')); btn.classList.add('active-btn'); renderContent(model,cap); });
        capacityContainer.appendChild(btn);
    });
}

async function initializePage(){
    const modelSelector=document.getElementById('model-selector');
    const showError=msg=>{ document.getElementById('ranking-container').innerHTML=`<p class="text-center p-8 text-red-500">${msg}</p>`; };
    try{
        const response=await fetch(CSV_URL); if(!response.ok) throw new Error('CSV取得エラー');
        const csvText=await response.text();
        const lines=csvText.split(/\r?\n/).filter(l=>l.trim()!=='');
        if(lines.length<3){ showError('CSVデータが不正です'); return; }
        const header=lines[0].split(',').map(s=>s.trim());
        const capacityRow=lines[1].split(',').map(s=>s.trim());
        allParsedData=[]; modelCapacityMap={};
        for(let r=2;r<lines.length;r++){
            const row=lines[r].split(',').map(s=>s.trim());
            const country=row[0]; if(!country) continue;
            for(let c=1;c<row.length;c++){
                const model=header[c]; const capacity=capacityRow[c]; if(!model||!capacity) continue;
                const price=parsePrice(row[c]);
                allParsedData.push({model,capacity,country,price,flag:'',taxRate:null,exchangeRate:null,localPrice:null,japanPrice:null,japanPriceTaxIn:null,currencySymbol:null});
                if(!modelCapacityMap[model]) modelCapacityMap[model]=[];
                if(!modelCapacityMap[model].includes(capacity)) modelCapacityMap[model].push(capacity);
            }
        }
        Object.keys(modelCapacityMap).forEach(model=>{
            const btn=document.createElement('button'); btn.textContent=model;
            btn.className='px-4 py-2 rounded-md bg-slate-100 text-slate-700 hover:bg-slate-200 font-semibold transition-colors';
            btn.addEventListener('click',()=>selectModel(model,btn));
            modelSelector.appendChild(btn);
        });
    }catch(e){ showError('データ読み込みに失敗しました'); console.error(e);}
}

initializePage();
</script>

</body>
</html>
