<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone 海外価格</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Inter','Noto Sans JP',sans-serif; padding:20px; }
.model-btn, .capacity-btn { margin:5px; padding:10px 15px; border-radius:8px; border:none; cursor:pointer; transition:0.2s; }
.model-btn.active, .capacity-btn.active { background-color:#4ade80; color:white; }
.model-btn { background-color:#e2e8f0; }
.capacity-btn { background-color:#f0f0f0; }
#priceTable { margin-top:20px; border-collapse: collapse; width:100%; }
#priceTable th, #priceTable td { border:1px solid #ddd; padding:8px; text-align:center; }
#priceTable th { background-color:#f3f4f6; }
</style>
</head>
<body>
<h1 class="text-xl font-bold mb-4">iPhone 海外価格一覧</h1>

<div>
    <h2 class="font-semibold">機種選択</h2>
    <div id="modelButtons"></div>
</div>

<div>
    <h2 class="font-semibold mt-4">容量選択</h2>
    <div id="capacityButtons"></div>
</div>

<table id="priceTable">
    <thead>
        <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
const CSV_URL = 'https://corsproxy.io/?https://www.dropbox.com/s/あなたのファイルパス/iphone_prices.csv?dl=1';
const MAX_RETRIES = 3;

// CSVを取得する関数（リトライ対応）
async function fetchCSV(url, retries = MAX_RETRIES) {
    for (let i = 0; i < retries; i++) {
        try {
            const res = await fetch(url, { cache:'no-store' });
            if (!res.ok) throw new Error('Network response not ok');
            const text = await res.text();
            return text;
        } catch (e) {
            console.warn(`Fetch failed (attempt ${i+1}): ${e}`);
            await new Promise(r => setTimeout(r, 1000)); // 1秒待機
        }
    }
    throw new Error('Failed to fetch CSV after retries');
}

// CSVをパース
function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    return lines.map(line => line.split(','));
}

// ボタン生成
function setupButtons(csv) {
    const header = csv[0];
    const capacityRow = csv[1];

    const modelCapacityMap = {};
    for (let col = 2; col < header.length; col++) {
        const model = header[col].trim();
        const capacity = capacityRow[col] ? capacityRow[col].trim() : "N/A";
        if (!model) continue;
        if (!modelCapacityMap[model]) modelCapacityMap[model] = [];
        if (!modelCapacityMap[model].includes(capacity)) modelCapacityMap[model].push(capacity);
    }

    const modelContainer = document.getElementById("modelButtons");
    const capacityContainer = document.getElementById("capacityButtons");

    modelContainer.innerHTML = '';
    capacityContainer.innerHTML = '';

    // 機種ボタン
    for (const model in modelCapacityMap) {
        const btn = document.createElement("button");
        btn.textContent = model;
        btn.classList.add("model-btn");
        btn.addEventListener("click", () => {
            document.querySelectorAll(".model-btn").forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            displayCapacities(modelCapacityMap[model], csv);
        });
        modelContainer.appendChild(btn);
    }
}

// 容量ボタン表示
function displayCapacities(capacities, csv) {
    const container = document.getElementById("capacityButtons");
    container.innerHTML = '';
    capacities.forEach(cap => {
        const btn = document.createElement("button");
        btn.textContent = cap;
        btn.classList.add("capacity-btn");
        btn.addEventListener("click", () => {
            document.querySelectorAll(".capacity-btn").forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            displayTable(csv, cap);
        });
        container.appendChild(btn);
    });
}

// 価格表表示
function displayTable(csv, selectedCapacity) {
    const header = csv[0];
    const capacityRow = csv[1];
    const tableHeader = document.getElementById("tableHeader");
    const tableBody = document.getElementById("tableBody");

    tableHeader.innerHTML = '';
    tableBody.innerHTML = '';

    // 表ヘッダ
    const cols = ["国名", "価格(税込)", "通貨"];
    cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c;
        tableHeader.appendChild(th);
    });

    for (let row = 2; row < csv.length; row++) {
        const tr = document.createElement("tr");
        const country = csv[row][0];
        const currency = csv[row][csv[row].length-1];
        let price = "N/A";

        // 選択容量列を探す
        for (let col = 2; col < csv[row].length; col++) {
            if (capacityRow[col] && capacityRow[col].trim() === selectedCapacity) {
                price = csv[row][col] || "N/A";
                break;
            }
        }

        [country, price, currency].forEach(v=>{
            const td = document.createElement("td");
            td.textContent = v;
            tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    }
}

// 初期化
(async () => {
    try {
        const csvText = await fetchCSV(CSV_URL);
        const csv = parseCSV(csvText);
        setupButtons(csv);
    } catch(e) {
        alert('CSV取得失敗: ' + e);
    }
})();
</script>
</body>
</html>
