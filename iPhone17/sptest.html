<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>相場グラフ - iPhone相場</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js と 日付アダプターライブラリを読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        .active-btn { 
            background-color:#2563eb !important; 
            color:white !important; 
            border-color: #2563eb !important;
            box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1); 
        }
        #period-selector:not(.visible){ display:none; }
        summary::-webkit-details-marker {
            display: none;
        }
        summary {
            list-style: none;
        }
        details[open] summary svg {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- ヘッダー -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-2xl font-bold text-blue-600">iPhone相場</a>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="../../index.html" class="text-slate-600 hover:text-blue-600 font-semibold">ホーム</a>
                <div class="relative js-dropdown">
                    <button data-dropdown-toggle="iphone17Dropdown" class="text-slate-600 hover:text-blue-600 font-semibold flex items-center">
                        iPhone 17
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="iphone17Dropdown" class="absolute hidden bg-white shadow-lg rounded-md py-2 w-56 z-20 border border-slate-100 top-full mt-2 right-0">
                        <a href="../../iPhone17/overseas-prices.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">海外価格</a>
                        <a href="../../iPhone17/market-graphs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場グラフ</a>
                        <a href="../../iPhone17/market-price-logs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場ログ</a>
                    </div>
                </div>
                <div class="relative js-dropdown">
                    <button data-dropdown-toggle="pastDataDropdown" class="text-slate-600 hover:text-blue-600 font-semibold flex items-center">
                        過去データ
                         <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                     <div id="pastDataDropdown" class="absolute hidden bg-white shadow-lg rounded-md py-2 w-56 z-20 border border-slate-100 top-full mt-2 right-0">
                        <a href="./market-graphs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場グラフ</a>
                        <a href="./market-price-logs.html" class="block px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600">相場ログ</a>
                    </div>
                </div>
            </nav>
            <button id="mobile-menu-button" class="block md:hidden text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>
    </header>

<main class="container mx-auto px-6 py-8 md:py-12">
    <h1 class="text-3xl font-bold text-slate-800 mb-6">過去の相場グラフ</h1>

    <div class="bg-white p-4 rounded-lg shadow-sm mb-8">
        <div id="model-selector" class="mb-4 flex flex-wrap justify-center gap-2 border-b pb-4">
            <p class="text-slate-500">データを読み込んでいます...</p>
        </div>
        <div id="period-selector" class="flex flex-wrap justify-center gap-2 pt-4"></div>
    </div>

    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
        <div id="graph-container" class="min-h-[400px]">
            <p class="text-center p-8 text-slate-500">機種と期間を選択してください。</p>
        </div>
    </div>
</main>

    <footer class="bg-slate-800 text-white mt-auto">
        <div class="container mx-auto px-6 py-8 text-center">
            <p>&copy; 2025 iPhone相場. All rights reserved.</p>
        </div>
    </footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=761980576&single=true&output=csv';
const PROXY_URL = `https://corsproxy.io/?${encodeURIComponent(CSV_URL)}`;

let allData = {};
let modelInfo = {}; // To store periods and capacities for each model
let chartInstance = null;

function parsePrice(str) {
    if (!str || typeof str !== 'string') return null;
    const n = parseFloat(str.replace(/[^0-9,]/g, ''));
    return isNaN(n) ? null : n;
}

function createChart(model, period) {
    const graphContainer = document.getElementById('graph-container');
    if (chartInstance) {
        chartInstance.destroy();
    }
    graphContainer.innerHTML = '<canvas id="priceChart"></canvas>';
    const ctx = document.getElementById('priceChart').getContext('2d');

    const chartData = allData[model]?.[period];

    if (!chartData || Object.keys(chartData.capacities).length === 0) {
        graphContainer.innerHTML = `<p class="text-center p-8 text-slate-500">選択された期間のグラフデータがありません。</p>`;
        return;
    }

    const colors = ['#3b82f6', '#10b981', '#f97316', '#ec4899', '#8b5cf6', '#ef4444'];
    let colorIndex = 0;
    const datasets = [];
    const sortedCapacities = Object.keys(chartData.capacities).sort((a, b) => parseInt(a) - parseInt(b));

    sortedCapacities.forEach(capacity => {
        const capacityData = chartData.capacities[capacity];
        const color = colors[colorIndex % colors.length];
        
        datasets.push({
            label: capacity,
            data: capacityData.data,
            borderColor: color,
            backgroundColor: color + '33', // Add alpha for fill
            borderWidth: 2.5,
            tension: 0.1,
            pointRadius: 1.5,
            pointHoverRadius: 5,
        });

        if (capacityData.list_price !== null) {
            datasets.push({
                label: `${capacity} 定価`,
                data: capacityData.data.map(d => ({ x: d.x, y: capacityData.list_price })),
                borderColor: color,
                borderWidth: 1.5,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
            });
        }
        colorIndex++;
    });

    chartInstance = new Chart(ctx, {
        type: 'line',
        data: { datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        tooltipFormat: 'yyyy/MM/dd HH:mm',
                        displayFormats: {
                           hour: 'MM/dd HH:mm',
                           day: 'yyyy/MM/dd',
                        }
                    },
                    title: { display: true, text: '日付' }
                },
                y: {
                    title: { display: true, text: '価格 (円)' },
                    ticks: {
                        callback: function(value) {
                            return '¥' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += '¥' + context.parsed.y.toLocaleString();
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}

function selectPeriod(model, period, btnElement) {
    document.querySelectorAll('#period-selector button').forEach(b => b.classList.remove('active-btn'));
    btnElement.classList.add('active-btn');
    createChart(model, period);
}

function selectModel(model, btnElement) {
    document.querySelectorAll('#model-selector button').forEach(b => b.classList.remove('active-btn'));
    btnElement.classList.add('active-btn');
    
    const periodSelector = document.getElementById('period-selector');
    periodSelector.classList.add('visible');
    periodSelector.innerHTML = '';
    
    const periods = Array.from(modelInfo[model].periods).sort();
    periods.forEach(period => {
        const btn = document.createElement('button');
        btn.textContent = period;
        btn.className = 'period-selector-btn px-4 py-2 text-sm font-semibold rounded-md transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200 border';
        btn.addEventListener('click', () => selectPeriod(model, period, btn));
        periodSelector.appendChild(btn);
    });

    document.getElementById('graph-container').innerHTML = `<p class="text-center p-8 text-slate-500">期間を選択してください。</p>`;
    if (chartInstance) chartInstance.destroy();
}

async function fetchWithRetry(url, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`サーバーエラー: ${response.status}`);
            }
            return response; // Success
        } catch (error) {
            console.error(`Attempt ${i + 1} failed:`, error.message);
            if (i === retries - 1) {
                throw error;
            }
            await new Promise(res => setTimeout(res, delay));
        }
    }
}

async function initializePage() {
    const modelSelector = document.getElementById('model-selector');
    const showError = msg => { 
        modelSelector.innerHTML = '';
        document.getElementById('graph-container').innerHTML = `<p class="text-center p-8 text-red-500">${msg}</p>`; 
    };

    try {
        const response = await fetchWithRetry(PROXY_URL);
        if (!response.ok) throw new Error('CSV取得エラー: ' + response.statusText);
        const csvText = await response.text();
        const rows = csvText.trim().split(/\r?\n/).map(r => r.split(','));

        if (rows.length < 5) throw new Error('CSVデータが不十分です。');
        
        const columnMetadata = [null]; // Index 0 is null for 1-based column mapping
        let lastPeriod = '';
        let lastModel = '';

        for (let c = 1; c < rows[2].length; c++) {
            const period = rows[0][c].trim() || lastPeriod;
            const model = rows[1][c].trim() || lastModel;
            const capacity = rows[2][c].trim();
            const list_price = parsePrice(rows[3][c]);
            
            if (period) lastPeriod = period;
            if (model) lastModel = model;

            if (model && period && capacity) {
                columnMetadata[c] = { model, period, capacity, list_price };

                if (!allData[model]) {
                    allData[model] = {};
                    modelInfo[model] = { periods: new Set() };
                }
                if (!allData[model][period]) {
                    allData[model][period] = { capacities: {} };
                }
                if (!allData[model][period].capacities[capacity]) {
                    allData[model][period].capacities[capacity] = { list_price: list_price, data: [] };
                    modelInfo[model].periods.add(period);
                }
            }
        }
        
        const dataRows = rows.slice(4);
        dataRows.forEach(row => {
            const dateStr = row[0].trim();
            if (!dateStr) return;

            for (let c = 1; c < row.length; c++) {
                const meta = columnMetadata[c];
                if (meta) {
                    const price = parsePrice(row[c]);
                    if (price !== null) {
                        allData[meta.model][meta.period].capacities[meta.capacity].data.push({ x: dateStr, y: price });
                    }
                }
            }
        });

        modelSelector.innerHTML = '';
        const modelOrder = [
            'iPhone 14', 'iPhone 14 Plus', 'iPhone 14 Pro', 'iPhone 14 Pro MAX',
            'iPhone 15', 'iPhone 15 Plus', 'iPhone 15 Pro', 'iPhone 15 Pro MAX',
            'iPhone 16', 'iPhone 16 Plus', 'iPhone 16 Pro', 'iPhone 16 Pro MAX'
        ];

        modelOrder.forEach(model => {
            if (modelInfo[model]) {
                 const btn = document.createElement('button');
                btn.textContent = model;
                btn.className = 'model-selector-btn px-4 py-2 text-sm font-semibold rounded-md transition-colors bg-white text-slate-700 shadow-sm hover:bg-slate-100 border';
                btn.addEventListener('click', () => selectModel(model, btn));
                modelSelector.appendChild(btn);
            }
        });

        if (Object.keys(modelInfo).length === 0) {
            showError('解析できる機種データがありません。CSVの形式を確認してください。');
        }

    } catch (e) {
        console.error(e);
        let errorMessage = `データ取得または処理に失敗しました。<br>エラー: ${e.message}`;
         if (e.message.includes('Failed to fetch')) {
             errorMessage = `ネットワークエラーによりデータを取得できませんでした。<br>インターネット接続を確認してください。`;
        }
        showError(errorMessage);
    }
}

function setupEventListeners() {
    // デスクトップ用ドロップダウン
    const dropdownToggles = document.querySelectorAll('[data-dropdown-toggle]');
    dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', function(event) {
            event.stopPropagation();
            const dropdownId = this.getAttribute('data-dropdown-toggle');
            const dropdownMenu = document.getElementById(dropdownId);
            
            document.querySelectorAll('.js-dropdown [id$="Dropdown"]').forEach(menu => {
                if (menu.id !== dropdownId) {
                    menu.classList.add('hidden');
                }
            });
            dropdownMenu.classList.toggle('hidden');
        });
    });

    // 他の場所をクリックしたらドロップダウンを閉じる
    window.addEventListener('click', function(event) {
        if (!event.target.closest('.js-dropdown')) {
            document.querySelectorAll('.js-dropdown [id$="Dropdown"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // モバイルメニューの制御
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenuButton && mobileMenu) {
        mobileMenuButton.addEventListener('click', (event) => {
            event.stopPropagation();
            mobileMenu.classList.toggle('hidden');
        });
    }
}


document.addEventListener('DOMContentLoaded', () => {
    initializePage();
    setupEventListeners();
});

</script>
</body>
</html>

