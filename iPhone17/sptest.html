<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>相場グラフ - iPhone相場</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
body { font-family: 'Inter','Noto Sans JP',sans-serif; margin:0; padding:0; background:#f1f5f9; }
header, footer { background:#1e293b; color:white; padding:1rem; text-align:center; }
.container { max-width:1200px; margin:2rem auto; padding:0 1rem; }
button { cursor:pointer; }
button.active-btn { background:#2563eb; color:white; border-color:#2563eb; }
#model-selector, #period-selector, #capacity-selector { margin-bottom:1rem; display:flex; flex-wrap:wrap; gap:0.5rem; }
#graph-container { background:white; padding:1rem; border-radius:0.5rem; min-height:400px; }
</style>
</head>
<body>
<header><h1>iPhone相場グラフ</h1></header>
<div class="container">

<div id="model-selector"></div>
<div id="period-selector"></div>
<div id="capacity-selector"></div>

<div id="graph-container"><canvas id="priceChart"></canvas></div>

</div>
<footer>&copy; 2025 iPhone相場</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=761980576&single=true&output=csv';

let allData = {};   // { model: { period: { capacity: { list_price, dates:[], prices:[] } } } }
let chartInstance = null;

function parsePrice(str) {
    if(!str) return null;
    const n = parseFloat(str.replace(/[^0-9.]/g,''));
    return isNaN(n)? null : n;
}

function clearChildren(el) { while(el.firstChild) el.removeChild(el.firstChild); }

function createChart(model, period, capacity) {
    if(chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('priceChart').getContext('2d');
    const dataObj = allData[model][period][capacity];
    const datasets = [
        {
            label: capacity,
            data: dataObj.dates.map((d,i)=>({x:d, y:dataObj.prices[i]})),
            borderColor:'#3b82f6',
            backgroundColor:'#3b82f633',
            tension:0.1,
            borderWidth:2.5,
            pointRadius:2
        },
        {
            label: capacity+' 定価',
            data: dataObj.dates.map(d=>({x:d, y:dataObj.list_price})),
            borderColor:'#f97316',
            borderDash:[5,5],
            pointRadius:0,
            fill:false
        }
    ];

    chartInstance = new Chart(ctx,{
        type:'line',
        data:{ datasets },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{
                x:{
                    type:'time',
                    time:{ tooltipFormat:'yyyy/MM/dd HH:mm', displayFormats:{ day:'MM/dd', hour:'MM/dd HH:mm'} },
                    title:{ display:true, text:'日付' }
                },
                y:{
                    title:{ display:true, text:'価格(円)' },
                    ticks:{ callback:v=>'¥'+v.toLocaleString() }
                }
            },
            plugins:{
                tooltip:{
                    callbacks:{
                        label:function(ctx){ return ctx.dataset.label + ': ¥' + ctx.parsed.y.toLocaleString(); }
                    }
                }
            }
        }
    });
}

function selectCapacity(model, period, capacity, btn) {
    document.querySelectorAll('#capacity-selector button').forEach(b=>b.classList.remove('active-btn'));
    btn.classList.add('active-btn');
    createChart(model, period, capacity);
}

function selectPeriod(model, period, btn) {
    document.querySelectorAll('#period-selector button').forEach(b=>b.classList.remove('active-btn'));
    btn.classList.add('active-btn');

    // 容量ボタン生成
    const capSelector = document.getElementById('capacity-selector');
    clearChildren(capSelector);
    const capacities = Object.keys(allData[model][period]);
    capacities.forEach(cap=>{
        const b = document.createElement('button');
        b.textContent = cap;
        b.addEventListener('click',()=>selectCapacity(model, period, cap, b));
        capSelector.appendChild(b);
    });

    // 自動で最初の容量を選択
    if(capacities.length>0) selectCapacity(model, period, capacities[0], capSelector.firstChild);
}

function selectModel(model, btn) {
    document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active-btn'));
    btn.classList.add('active-btn');

    const periodSelector = document.getElementById('period-selector');
    clearChildren(periodSelector);
    const periods = Object.keys(allData[model]).sort();
    periods.forEach(p=>{
        const b = document.createElement('button');
        b.textContent = p;
        b.addEventListener('click',()=>selectPeriod(model, p, b));
        periodSelector.appendChild(b);
    });

    if(periods.length>0) selectPeriod(model, periods[0], periodSelector.firstChild);
}

async function initializePage() {
    const modelSelector = document.getElementById('model-selector');
    try{
        const res = await fetch(CSV_URL);
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
        if(rows.length<5) throw new Error('CSV不十分');

        const headerDates = rows.slice(4).map(r=>r[0].trim()); // 1列目に日付
        const numCols = rows[0].length;

        for(let c=1;c<numCols;c++){
            const period = rows[0][c].trim();
            const model = rows[1][c].trim();
            const capacity = rows[2][c].trim();
            const list_price = parsePrice(rows[3][c]);

            if(!model || !period || !capacity) continue;

            if(!allData[model]) allData[model]={};
            if(!allData[model][period]) allData[model][period]={};
            allData[model][period][capacity] = { list_price, dates:[], prices:[] };

            const dataCol = rows.slice(4).map(r=>r[c].trim());
            for(let i=0;i<dataCol.length;i++){
                if(dataCol[i]==='') break; // 空白セルで終了
                const price = parsePrice(dataCol[i]);
                if(price!==null){
                    allData[model][period][capacity].dates.push(headerDates[i]);
                    allData[model][period][capacity].prices.push(price);
                }
            }
        }

        // 機種ボタン生成
        Object.keys(allData).sort().forEach(model=>{
            const b = document.createElement('button');
            b.textContent = model;
            b.addEventListener('click',()=>selectModel(model, b));
            modelSelector.appendChild(b);
        });

        if(Object.keys(allData).length>0){
            selectModel(Object.keys(allData)[0], modelSelector.firstChild);
        }

    } catch(e){
        console.error(e);
        modelSelector.innerHTML='<p style="color:red;">データ取得に失敗しました</p>';
    }
}

document.addEventListener('DOMContentLoaded',()=>{ initializePage(); });

</script>
</body>
</html>
