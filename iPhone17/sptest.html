<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone 相場グラフ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
<script>
  dayjs.extend(dayjs_plugin_customParseFormat);
  dayjs.extend(dayjs_plugin_utc);
  dayjs.extend(dayjs_plugin_timezone);
</script>
<style>
html, body { height: 100%; margin:0; }
body { font-family: 'Inter','Noto Sans JP',sans-serif; display:flex; flex-direction:column; min-height:100vh; background:#f1f5f9; }
header, footer { flex-shrink:0; }
main { flex-grow:1; display:flex; flex-direction:column; padding:1.5rem; }
.model-btn, .period-btn { cursor:pointer; padding:0.5rem 1rem; border-radius:0.375rem; font-weight:600; border:1px solid #cbd5e1; transition:0.2s; background:#fff; color:#374151; }
.model-btn.active-btn, .period-btn.active-btn { background:#2563eb; color:#fff; border-color:#2563eb; }
.model-btn:hover, .period-btn:hover { background:#e2e8f0; }
#graph-container { flex-grow:1; position:relative; min-height:60vh; background:#fff; border-radius:0.5rem; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-top:1rem; }
#priceChart { position:absolute; top:0; left:0; width:100%; height:100%; }
#graph-placeholder { position:absolute; inset:0; display:flex; justify-content:center; align-items:center; color:#94a3b8; }
</style>
</head>
<body>

<header class="bg-white shadow-md p-4 text-xl font-bold text-blue-600">iPhone相場</header>

<main>
  <h2 class="text-center text-lg font-semibold text-slate-700 mb-2">1. 機種を選択</h2>
  <div class="flex flex-wrap justify-center gap-2 mb-4" id="model-selector"></div>
  
  <h2 class="text-center text-lg font-semibold text-slate-700 my-2" id="period-title" style="display: none;">2. 期間を選択</h2>
  <div class="flex flex-wrap justify-center gap-2 mb-4" id="period-selector"></div>
  
  <div id="graph-container">
    <canvas id="priceChart" style="display:none;"></canvas>
    <div id="graph-placeholder">機種を選択してください</div>
  </div>
</main>

<footer class="bg-slate-800 text-white text-center p-4">&copy; 2025 iPhone相場</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=8162687&single=true&output=csv';

let allData = {};
let modelInfo = {};
let chartInstance = null;

function parsePrice(str){
  if(!str) return null;
  str = str.replace(/["¥,]/g,'').trim();
  const n = parseFloat(str);
  return isNaN(n)? null:n;
}

function createChart(model, period){
  const canvas = document.getElementById('priceChart');
  const placeholder = document.getElementById('graph-placeholder');
  
  if(chartInstance){
    chartInstance.destroy();
    chartInstance = null;
  }
  
  canvas.style.display = 'block';
  placeholder.style.display = 'none';
  const ctx = canvas.getContext('2d');

  const chartData = allData[model]?.[period];
  if(!chartData || Object.keys(chartData.capacities).length === 0){
    placeholder.textContent='選択された期間のグラフデータがありません。';
    placeholder.style.display='flex';
    canvas.style.display='none';
    return;
  }
  
  // ✅ FIX: Get labels directly from the first capacity's data.
  // The parsing logic now ensures all capacities have the same dates in the same order.
  // This respects the original order from the CSV file.
  const firstCapacityKey = Object.keys(chartData.capacities)[0];
  if (!firstCapacityKey) {
    placeholder.textContent='選択された期間のグラフデータがありません。';
    placeholder.style.display='flex';
    canvas.style.display='none';
    return;
  }
  
  const labels = chartData.capacities[firstCapacityKey].data.map(point => point.date);

  const colors = ['#3b82f6','#10b981','#f97316','#ec4899','#8b5cf6','#ef4444'];
  let colorIndex = 0;
  const datasets = [];
  const capacities = Object.keys(chartData.capacities).sort((a,b)=>parseInt(a)-parseInt(b));

  capacities.forEach(cap=>{
    const capData = chartData.capacities[cap];
    const color = colors[colorIndex % colors.length];

    // ✅ FIX: Data is now pre-aligned. Just extract the prices.
    const alignedPriceData = capData.data.map(point => point.price);

    datasets.push({
      label: cap,
      data: alignedPriceData,
      borderColor: color,
      borderWidth: 2.5,
      fill: false,
      pointRadius: 0,
      tension: 0.1,
      spanGaps: true
    });

    if(capData.list_price){
      datasets.push({
        label: cap+' 定価',
        data: new Array(labels.length).fill(capData.list_price),
        borderColor: color,
        borderWidth: 1.5,
        borderDash: [5,5],
        fill: false,
        pointRadius: 0,
        tension: 0.1
      });
    }
    colorIndex++;
  });

  chartInstance = new Chart(ctx,{
    type: 'line',
    data: { 
        labels: labels,
        datasets: datasets 
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'category',
          title: { display: true, text: '日付' },
          ticks: {
            autoSkip: true,
            maxRotation: 0,
            minRotation: 0,
            maxTicksLimit: 10
          }
        },
        y: {
          title: { display: true, text: '価格 (円)' },
          ticks: { callback: v=>'¥'+v.toLocaleString() }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx){
              let label=ctx.dataset.label||'';
              if(label) label+=': ';
              if (ctx.parsed.y !== null) {
                label+='¥'+ctx.parsed.y.toLocaleString();
              }
              return label;
            }
          }
        }
      }
    }
  });
}

function selectPeriod(model, period, btn){
  document.querySelectorAll('#period-selector button').forEach(b=>b.classList.remove('active-btn'));
  btn.classList.add('active-btn');
  createChart(model, period);
}

function selectModel(model, btn){
  document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active-btn'));
  btn.classList.add('active-btn');

  document.getElementById('period-title').style.display = 'block';

  const periodSelector = document.getElementById('period-selector');
  periodSelector.innerHTML='';

  const periodOrder = ['1週間','1ヶ月','3ヶ月','6ヶ月'];
  const periods = Array.from(modelInfo[model].periods);
  periods.sort((a,b)=> periodOrder.indexOf(a) - periodOrder.indexOf(b));

  periods.forEach(p=>{
    const btn=document.createElement('button');
    btn.textContent=p;
    btn.className='period-btn';
    btn.addEventListener('click',()=>selectPeriod(model,p,btn));
    periodSelector.appendChild(btn);
  });

  const canvas = document.getElementById('priceChart');
  const placeholder = document.getElementById('graph-placeholder');
  canvas.style.display='none';
  placeholder.style.display='flex';
  placeholder.textContent='期間を選択してください';
  if(chartInstance){
    chartInstance.destroy();
    chartInstance=null;
  }
}

async function initializePage(){
  const modelSelector = document.getElementById('model-selector');
  const showError = msg=>{
    modelSelector.innerHTML='';
    const placeholder=document.getElementById('graph-placeholder');
    placeholder.style.display='flex';
    placeholder.textContent=msg;
  };

  try{
    const response = await fetch(CSV_URL);
    if(!response.ok) throw new Error('CSV取得失敗: '+response.statusText);
    const text = await response.text();
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));

    if(rows.length < 4) throw new Error('CSVデータが不十分です。');

    const modelsHeader = rows[0];
    const capacitiesHeader = rows[1];
    const listPricesHeader = rows[2];
    const dataRows = rows.slice(3);
    
    const configBySeries = {
      'iPhone 14': {
        '1週間': { dateCol: 0, rows: 8, priceColStart: 1, priceColEnd: 12 },
        '1ヶ月': { dateCol: 0, rows: 31, priceColStart: 1, priceColEnd: 12 },
        '3ヶ月': { dateCol: 0, rows: 92, priceColStart: 1, priceColEnd: 12 },
        '6ヶ月': { dateCol: 0, rows: 182, priceColStart: 1, priceColEnd: 12 }
      },
      'iPhone 15': {
        '1週間': { dateCol: 13, rows: 192, priceColStart: 14, priceColEnd: 26 },
        '1ヶ月': { dateCol: 13, rows: 744, priceColStart: 14, priceColEnd: 26 },
        '3ヶ月': { dateCol: 27, rows: 92, priceColStart: 28, priceColEnd: 40 },
        '6ヶ月': { dateCol: 27, rows: 182, priceColStart: 28, priceColEnd: 40 }
      },
      'iPhone 16': {
        '1週間': { dateCol: 41, rows: 192, priceColStart: 42, priceColEnd: 54 },
        '1ヶ月': { dateCol: 41, rows: 744, priceColStart: 42, priceColEnd: 54 },
        '3ヶ月': { dateCol: 55, rows: 92, priceColStart: 56, priceColEnd: 68 },
        '6ヶ月': { dateCol: 55, rows: 182, priceColStart: 56, priceColEnd: 68 }
      }
    };

    for (const seriesKey in configBySeries) {
      const seriesPeriods = configBySeries[seriesKey];
      for (const periodName in seriesPeriods) {
        const config = seriesPeriods[periodName];
        const { dateCol, rows: numRows, priceColStart, priceColEnd } = config;
        const relevantRows = dataRows.slice(0, numRows);

        for (let c = priceColStart; c <= priceColEnd; c++) {
          const model = modelsHeader[c]?.trim();
          const capacity = capacitiesHeader[c]?.trim();
          const list_price = parsePrice(listPricesHeader[c]);

          if (!model || model === '機種' || !capacity) continue;
          
          if (!allData[model]) {
            allData[model] = {};
            modelInfo[model] = { periods: new Set() };
          }
          if (!allData[model][periodName]) {
            allData[model][periodName] = { capacities: {} };
          }
          if (!allData[model][periodName].capacities[capacity]) {
            allData[model][periodName].capacities[capacity] = {
                list_price: list_price,
                data: []
            };
          }
          modelInfo[model].periods.add(periodName);
          
          const currentSeriesData = allData[model][periodName].capacities[capacity].data;
          
          relevantRows.forEach(row => {
            const dateStr = row[dateCol]?.trim();
            // ✅ FIX: Push data point as long as a date exists, even if price is null.
            // This ensures all data arrays for a given period have the same length and order.
            if (dateStr) {
                const price = parsePrice(row[c]);
                currentSeriesData.push({ date: dateStr, price: price });
            }
          });
        }
      }
    }

    const modelsOrder = ['iPhone 14','iPhone 14 Plus','iPhone 14 Pro','iPhone 14 Pro MAX','iPhone 15','iPhone 15 Plus','iPhone 15 Pro','iPhone 15 Pro MAX','iPhone 16','iPhone 16 Plus','iPhone 16 Pro','iPhone 16 Pro MAX'];
    modelsOrder.forEach(m=>{
      if(!allData[m]) return;
      const btn=document.createElement('button');
      btn.textContent=m;
      btn.className='model-btn';
      btn.addEventListener('click',()=>selectModel(m,btn));
      modelSelector.appendChild(btn);
    });

    if(Object.keys(modelInfo).length === 0) showError('解析できるデータがありません');

  }catch(e){
    console.error(e);
    showError('データ取得または処理に失敗しました: '+e.message);
  }
}

document.addEventListener('DOMContentLoaded',initializePage);
</script>

</body>
</html>

