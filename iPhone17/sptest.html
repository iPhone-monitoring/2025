<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone相場グラフ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
body { font-family: 'Inter', 'Noto Sans JP', sans-serif; display:flex; flex-direction:column; min-height:100vh; }
main { flex-grow:1; }
.active-btn { background-color:#2563eb !important; color:white !important; border-color:#2563eb !important; box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);}
#period-selector:not(.visible){ display:none; }
summary::-webkit-details-marker { display: none; }
summary { list-style: none; }
details[open] summary svg { transform: rotate(180deg); }
</style>
</head>
<body class="bg-slate-50 text-slate-800">

<main class="container mx-auto px-6 py-8 md:py-12">
<h1 class="text-3xl font-bold text-slate-800 mb-6">過去の相場グラフ</h1>

<div class="bg-white p-4 rounded-lg shadow-sm mb-8">
    <div id="model-selector" class="mb-4 flex flex-wrap justify-center gap-2 border-b pb-4"></div>
    <div id="period-selector" class="flex flex-wrap justify-center gap-2 pt-4"></div>
</div>

<div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
    <div id="graph-container" class="min-h-[400px]">
        <p class="text-center p-8 text-slate-500">機種と期間を選択してください。</p>
    </div>
</div>
</main>

<footer class="bg-slate-800 text-white mt-auto">
<div class="container mx-auto px-6 py-8 text-center">
<p>&copy; 2025 iPhone相場. All rights reserved.</p>
</div>
</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=761980576&single=true&output=csv';
let allData = {};
let chartInstance = null;

function parsePrice(str){
    if(!str||typeof str!=='string') return null;
    const n = parseFloat(str.replace(/[^0-9.]/g,''));
    return isNaN(n)?null:n;
}

function findColumns(rows, model, period){
    let cols = [];
    for(let c=1;c<rows[0].length;c++){
        if(rows[1][c].trim()===model && rows[0][c].trim()===period) cols.push(c);
    }
    return cols;
}

function findXAxis(rows, col){
    for(let r=4;r<rows.length;r++){
        let val = rows[r][col].trim();
        if(val && isNaN(val)) return r; // 最初に出会う非数セル
    }
    return 4; // fallback
}

function createChart(rows, model, period){
    const cols = findColumns(rows, model, period);
    if(cols.length===0){
        document.getElementById('graph-container').innerHTML='<p class="text-center p-8 text-red-500">対象データがありません。</p>';
        return;
    }

    const datasets=[];
    const colors=['#3b82f6','#10b981','#f97316','#ec4899','#8b5cf6','#ef4444'];
    let colorIndex=0;

    cols.forEach(col=>{
        const capacity = rows[2][col].trim();
        const list_price = parsePrice(rows[3][col]);
        const xRow = findXAxis(rows,col);
        const data=[];
        for(let r=xRow;r<rows.length;r++){
            const dateStr = rows[r][0].trim();
            const price = parsePrice(rows[r][col]);
            if(dateStr && price!==null) data.push({x:dateStr,y:price});
        }

        datasets.push({
            label:capacity,
            data:data,
            borderColor:colors[colorIndex%colors.length],
            backgroundColor:colors[colorIndex%colors.length]+'33',
            tension:0.1,
            pointRadius:1.5,
            pointHoverRadius:5,
            borderWidth:2
        });

        if(list_price!==null){
            datasets.push({
                label:`${capacity} 定価`,
                data:data.map(d=>({x:d.x,y:list_price})),
                borderColor:colors[colorIndex%colors.length],
                borderWidth:1.5,
                borderDash:[5,5],
                pointRadius:0,
                fill:false
            });
        }
        colorIndex++;
    });

    document.getElementById('graph-container').innerHTML='<canvas id="priceChart"></canvas>';
    const ctx = document.getElementById('priceChart').getContext('2d');

    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx,{
        type:'line',
        data:{datasets:datasets},
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{
                x:{
                    type:'time',
                    time:{
                        parser: val => val,
                        tooltipFormat:'yyyy/MM/dd HH:mm',
                        displayFormats:{
                            day:'yyyy/MM/dd',
                            hour:'MM/dd HH:mm'
                        }
                    },
                    title:{display:true,text:'日付'}
                },
                y:{
                    title:{display:true,text:'価格(円)'},
                    ticks:{callback:v=>'¥'+v.toLocaleString()}
                }
            },
            plugins:{
                tooltip:{
                    callbacks:{
                        label:ctx=>{
                            let label=ctx.dataset.label||'';
                            if(label) label+=': ';
                            if(ctx.parsed.y!==null) label+='¥'+ctx.parsed.y.toLocaleString();
                            return label;
                        }
                    }
                }
            }
        }
    });
}

async function initializePage(){
    try{
        const res=await fetch(CSV_URL);
        const csvText=await res.text();
        const rows = csvText.trim().split(/\r?\n/).map(r=>r.split(','));

        const models=new Set();
        for(let c=1;c<rows[0].length;c++) models.add(rows[1][c].trim());
        const modelSelector=document.getElementById('model-selector');
        modelSelector.innerHTML='';
        models.forEach(model=>{
            const btn=document.createElement('button');
            btn.textContent=model;
            btn.className='px-4 py-2 text-sm font-semibold rounded-md transition-colors bg-white text-slate-700 shadow-sm hover:bg-slate-100 border';
            btn.addEventListener('click',()=>{
                document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active-btn'));
                btn.classList.add('active-btn');

                const periodSelector=document.getElementById('period-selector');
                periodSelector.classList.add('visible');
                periodSelector.innerHTML='';

                const periods=new Set();
                for(let c=1;c<rows[0].length;c++){
                    if(rows[1][c].trim()===model) periods.add(rows[0][c].trim());
                }

                const order=['1週間','1ヶ月','3ヶ月','6ヶ月'];
                order.forEach(p=>{
                    if(periods.has(p)){
                        const pBtn=document.createElement('button');
                        pBtn.textContent=p;
                        pBtn.className='px-4 py-2 text-sm font-semibold rounded-md transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200 border';
                        pBtn.addEventListener('click',()=>{ 
                            document.querySelectorAll('#period-selector button').forEach(b=>b.classList.remove('active-btn'));
                            pBtn.classList.add('active-btn');
                            createChart(rows,model,p);
                        });
                        periodSelector.appendChild(pBtn);
                    }
                });
                document.getElementById('graph-container').innerHTML='<p class="text-center p-8 text-slate-500">期間を選択してください。</p>';
            });
            modelSelector.appendChild(btn);
        });

    }catch(e){
        console.error(e);
        document.getElementById('graph-container').innerHTML='<p class="text-center p-8 text-red-500">データ取得に失敗しました</p>';
    }
}

document.addEventListener('DOMContentLoaded',()=>{initializePage();});
</script>
</body>
</html>
