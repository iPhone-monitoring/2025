<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>相場グラフ - iPhone相場</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:'Inter','Noto Sans JP',sans-serif; display:flex; flex-direction:column; min-height:100vh; background-color:#f8fafc; color:#1e293b; }
header, footer { background-color:white; }
header { box-shadow:0 2px 4px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
.container { max-width:1024px; margin:0 auto; padding:1rem; }
.model-btn.active-btn { background-color:#2563eb !important; color:white !important; }
.period-btn.active-btn { background-color:#2563eb !important; color:white !important; }
</style>
</head>
<body>
<header class="container flex justify-between items-center py-4">
  <h1 class="text-xl font-bold text-blue-600">iPhone相場</h1>
</header>

<main class="container flex-1 py-6">
  <h2 class="text-2xl font-bold mb-4">過去の相場グラフ</h2>

  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <div id="model-selector" class="flex flex-wrap gap-2 mb-4"></div>
    <div id="period-selector" class="flex flex-wrap gap-2 pt-2"></div>
  </div>

  <div class="bg-white p-4 rounded-lg shadow">
    <canvas id="priceChart" class="w-full" height="400"></canvas>
  </div>
</main>

<footer class="container text-center py-4 text-sm text-slate-500">
  &copy; 2025 iPhone相場
</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=8162687&single=true&output=csv';
let allData = {}, chartInstance = null;
const modelOrder = ["iPhone 14","iPhone 14 Plus","iPhone 14 Pro","iPhone 14 Pro MAX","iPhone 15","iPhone 15 Plus","iPhone 15 Pro","iPhone 15 Pro MAX","iPhone 16","iPhone 16 Plus","iPhone 16 Pro","iPhone 16 Pro MAX"];

function parsePrice(str){
  if(!str) return null;
  str = str.replace(/["]/g,'').replace(/,/g,'').trim();
  const n = parseFloat(str);
  return isNaN(n)?null:n;
}

function createChart(model, period){
  const ctx = document.getElementById('priceChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();

  const dataObj = allData[model][period];
  if(!dataObj) return;

  const colors = ['#3b82f6','#10b981','#f97316','#ec4899','#8b5cf6','#ef4444'];
  let datasets = [];
  let colorIndex = 0;

  Object.keys(dataObj.capacities).forEach(cap => {
    const capData = dataObj.capacities[cap];
    datasets.push({
      label: cap,
      data: capData.data.map((v,i)=>({x:v.label, y:v.price})),
      borderColor: colors[colorIndex%colors.length],
      borderWidth:2,
      fill:false,
      pointRadius:0,
      tension:0.1
    });
    if(capData.list_price){
      datasets.push({
        label: cap+' 定価',
        data: capData.data.map(v=>({x:v.label, y:capData.list_price})),
        borderColor:colors[colorIndex%colors.length],
        borderWidth:1.5,
        borderDash:[5,5],
        fill:false,
        pointRadius:0
      });
    }
    colorIndex++;
  });

  chartInstance = new Chart(ctx,{
    type:'line',
    data:{datasets:datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ 
          type:'category',
          title:{display:true,text:'日付'},
        },
        y:{
          title:{display:true,text:'価格 (円)'},
          ticks:{
            callback:function(val){return '¥'+val.toLocaleString();}
          }
        }
      },
      plugins:{
        tooltip:{
          callbacks:{
            label:function(context){
              return context.dataset.label + ': ¥' + context.parsed.y.toLocaleString();
            }
          }
        }
      }
    }
  });
}

function selectPeriod(model, period, btn){
  document.querySelectorAll('#period-selector button').forEach(b=>b.classList.remove('active-btn'));
  btn.classList.add('active-btn');
  createChart(model, period);
}

function selectModel(model, btn){
  document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active-btn'));
  btn.classList.add('active-btn');

  const periods = Object.keys(allData[model]).sort((a,b)=>{
    const order={'1週間':0,'1ヶ月':1,'3ヶ月':2,'6ヶ月':3};
    return order[a]-order[b];
  });

  const periodSelector = document.getElementById('period-selector');
  periodSelector.innerHTML='';
  periods.forEach(p=>{
    const b = document.createElement('button');
    b.textContent=p;
    b.className='period-btn px-3 py-1 text-sm border rounded hover:bg-slate-100';
    b.addEventListener('click',()=>selectPeriod(model,p,b));
    periodSelector.appendChild(b);
  });

  document.getElementById('priceChart').getContext('2d').clearRect(0,0,1000,400);
}

async function initializePage(){
  const modelSelector = document.getElementById('model-selector');
  modelSelector.innerHTML='データを読み込んでいます...';

  try{
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error(res.statusText);
    const text = await res.text();
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));

    // 1行目:期間, 2行目:機種, 3行目:容量, 4行目:定価, 5行目以降:日付+価格
    const headerPeriod = rows[0].map(s=>s.replace(/["]/g,'').trim());
    const headerModel = rows[1].map(s=>s.replace(/["]/g,'').trim());
    const headerCapacity = rows[2].map(s=>s.replace(/["]/g,'').trim());
    const headerListPrice = rows[3].map(s=>parsePrice(s));

    const dataRows = rows.slice(4);

    // 機種・期間・容量別にデータ格納
    for(let c=1;c<rows[0].length;c++){
      const period=headerPeriod[c];
      const model=headerModel[c];
      const capacity=headerCapacity[c];
      const list_price=headerListPrice[c];

      if(!allData[model]) allData[model]={};
      if(!allData[model][period]) allData[model][period]={capacities:{}};
      if(!allData[model][period].capacities[capacity]){
        allData[model][period].capacities[capacity]={list_price:list_price,data:[]};
      }

      // 横軸データ探索（左方向で最初に / を含むセル）
      dataRows.forEach(row=>{
        let label='';
        for(let j=c;j>=0;j--){
          if(row[j] && row[j].includes('/')){
            label=row[j].trim();
            break;
          }
        }
        const price=parsePrice(row[c]);
        if(label && price!==null){
          allData[model][period].capacities[capacity].data.push({label,price});
        }
      });
    }

    // 機種ボタン生成
    modelSelector.innerHTML='';
    modelOrder.forEach(m=>{
      if(allData[m]){
        const btn=document.createElement('button');
        btn.textContent=m;
        btn.className='model-btn px-3 py-1 text-sm border rounded hover:bg-slate-100';
        btn.addEventListener('click',()=>selectModel(m,btn));
        modelSelector.appendChild(btn);
      }
    });

  }catch(e){
    console.error(e);
    modelSelector.innerHTML='ネットワークエラーによりデータを取得できませんでした。<br>インターネット接続を確認してください。';
  }
}

document.addEventListener('DOMContentLoaded',()=>{initializePage();});
</script>
</body>
</html>
