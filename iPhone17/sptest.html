<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>相場グラフ - iPhone相場</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Inter','Noto Sans JP',sans-serif; background:#f8fafc; color:#1e293b; display:flex; flex-direction:column; min-height:100vh;}
header, footer { background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
header a { font-weight:bold; color:#2563eb;}
main { flex-grow:1; }
.model-btn, .period-btn { margin:2px; padding:6px 12px; border-radius:6px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; transition:0.2s;}
.model-btn.active, .period-btn.active { background:#2563eb; color:#fff; border-color:#2563eb;}
</style>
</head>
<body>
<header class="px-6 py-4 flex items-center space-x-4">
  <a href="../../index.html" class="text-xl">iPhone相場</a>
</header>

<main class="container mx-auto px-6 py-6">
  <h1 class="text-2xl font-bold mb-4">過去の相場グラフ</h1>

  <div id="model-selector" class="mb-4 flex flex-wrap"></div>
  <div id="period-selector" class="mb-4 flex flex-wrap"></div>

  <div class="bg-white p-4 rounded shadow">
    <canvas id="priceChart" class="min-h-[400px]"></canvas>
  </div>
</main>

<footer class="text-center py-4 text-sm text-slate-500">&copy; 2025 iPhone相場</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=8162687&single=true&output=csv';

let allData = {};
let chartInstance = null;
const modelOrder = ['iPhone 14','iPhone 14 Plus','iPhone 14 Pro','iPhone 14 Pro MAX','iPhone 15','iPhone 15 Plus','iPhone 15 Pro','iPhone 15 Pro MAX','iPhone 16','iPhone 16 Plus','iPhone 16 Pro','iPhone 16 Pro MAX'];

function parsePrice(str){
  if(!str) return null;
  return Number(str.replace(/,/g,'').replace(/"/g,''));
}

function createChart(model, period){
  const ctx = document.getElementById('priceChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();

  const chartData = allData[model][period];
  if(!chartData){ ctx.canvas.parentNode.innerHTML='<p class="text-center p-8 text-gray-500">データなし</p>'; return;}

  const colors = ['#3b82f6','#10b981','#f97316','#ec4899','#8b5cf6','#ef4444'];
  const datasets = [];
  let colorIndex = 0;

  Object.keys(chartData.capacities).forEach(cap=>{
    const data = chartData.capacities[cap].data;
    datasets.push({
      label: cap,
      data: data.map((d,i)=>({x:i, y:d})),
      borderColor: colors[colorIndex % colors.length],
      borderWidth: 2.5,
      fill:false,
      pointRadius:0,
      tension:0.1
    });
    // 定価線
    datasets.push({
      label: cap+' 定価',
      data: data.map(()=>chartData.capacities[cap].list_price),
      borderColor: colors[colorIndex % colors.length],
      borderWidth:1.5,
      borderDash:[5,5],
      fill:false,
      pointRadius:0
    });
    colorIndex++;
  });

  chartInstance = new Chart(ctx,{
    type:'line',
    data:{datasets:datasets, labels:chartData.labels},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{position:'bottom'}},
      scales:{
        x:{ title:{display:true,text:'日付'} },
        y:{ title:{display:true,text:'価格 (円)'} }
      }
    }
  });
}

function selectPeriod(model, period, btn){
  document.querySelectorAll('#period-selector button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  createChart(model, period);
}

function selectModel(model, btn){
  document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');

  const periods = Object.keys(allData[model]).sort((a,b)=>a.localeCompare(b));
  const periodContainer = document.getElementById('period-selector');
  periodContainer.innerHTML='';
  periods.forEach(p=>{
    const b = document.createElement('button');
    b.textContent=p;
    b.className='period-btn';
    b.addEventListener('click',()=>selectPeriod(model,p,b));
    periodContainer.appendChild(b);
  });
}

async function initializePage(){
  const modelContainer = document.getElementById('model-selector');
  try{
    const res = await fetch(CSV_URL);
    const csvText = await res.text();
    const rows = csvText.trim().split(/\r?\n/).map(r=>r.split(','));
    const headers = rows.slice(0,4);
    const dataRows = rows.slice(4);

    // 機種ごとに整理
    modelOrder.forEach(model=>{
      allData[model]={};
      headers[0].forEach((period,i)=>{
        if(headers[1][i]!==model) return;
        const periodName = period;
        if(!allData[model][periodName]) allData[model][periodName]={capacities:{},labels:[]};

        const capacity = headers[2][i];
        const list_price = parsePrice(headers[3][i]);
        const prices=[];
        const labels=[];
        for(let r=0;r<dataRows.length;r++){
          const val = parsePrice(dataRows[r][i]);
          if(val!==null) { prices.push(val); labels.push(dataRows[r][0]); }
        }
        allData[model][periodName].capacities[capacity]={list_price:list_price,data:prices};
        allData[model][periodName].labels=labels;
      });
    });

    // 機種ボタン生成
    modelOrder.forEach(m=>{
      const b = document.createElement('button');
      b.textContent=m;
      b.className='model-btn';
      b.addEventListener('click',()=>selectModel(m,b));
      modelContainer.appendChild(b);
    });

  }catch(e){
    console.error(e);
    modelContainer.innerHTML='<p class="text-red-500">ネットワークエラーによりデータを取得できませんでした。インターネット接続を確認してください。</p>';
  }
}

document.addEventListener('DOMContentLoaded',()=>initializePage());
</script>
</body>
</html>
