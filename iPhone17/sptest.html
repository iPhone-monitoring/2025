<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>過去相場グラフ - iPhone相場</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
body { font-family:'Inter','Noto Sans JP',sans-serif; display:flex; flex-direction:column; min-height:100vh; background:#f1f5f9; color:#1e293b; }
main { flex-grow:1; }
button { cursor:pointer; }
.model-btn, .period-btn { border-radius:0.375rem; padding:0.5rem 1rem; font-weight:600; transition:0.2s; }
.model-btn { background:white; color:#334155; border:1px solid #cbd5e1; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
.model-btn.active-btn, .period-btn.active-btn { background:#2563eb; color:white; border-color:#2563eb; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -2px rgba(0,0,0,0.1); }
.period-btn { background:#e2e8f0; color:#334155; border:1px solid #cbd5e1; }
</style>
</head>
<body>

<header class="bg-white shadow-md sticky top-0 z-10">
<div class="container mx-auto px-6 py-4 flex justify-between items-center">
<h1 class="text-2xl font-bold text-blue-600">iPhone相場</h1>
</div>
</header>

<main class="container mx-auto px-6 py-8">
<h2 class="text-3xl font-bold mb-6">過去の相場グラフ</h2>

<div class="bg-white p-4 rounded-lg shadow-sm mb-8">
<div id="model-selector" class="flex flex-wrap gap-2 justify-center mb-4">
<!-- 機種ボタン -->
</div>
<div id="period-selector" class="flex flex-wrap gap-2 justify-center pt-4">
<!-- 期間ボタン -->
</div>
</div>

<div class="bg-white p-4 rounded-lg shadow-md">
<div id="graph-container" class="min-h-[400px]">
<p class="text-center p-8 text-slate-500">機種と期間を選択してください。</p>
</div>
</div>
</main>

<footer class="bg-slate-800 text-white mt-auto">
<div class="container mx-auto px-6 py-8 text-center">
<p>&copy; 2025 iPhone相場. All rights reserved.</p>
</div>
</footer>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=8162687&single=true&output=csv';

let allData = {};
let modelInfo = {};
let chartInstance = null;

function parsePrice(str) {
    if (!str) return null;
    const n = parseFloat(str.replace(/[^\d.]/g,''));
    return isNaN(n) ? null : n;
}

function createChart(model, period) {
    const graphContainer = document.getElementById('graph-container');
    if (chartInstance) chartInstance.destroy();
    graphContainer.innerHTML = '<canvas id="priceChart"></canvas>';
    const ctx = document.getElementById('priceChart').getContext('2d');

    const chartData = allData[model]?.[period];
    if (!chartData) {
        graphContainer.innerHTML = `<p class="text-center p-8 text-slate-500">選択された期間のグラフデータがありません。</p>`;
        return;
    }

    const colors = ['#3b82f6','#10b981','#f97316','#ec4899','#8b5cf6','#ef4444'];
    const datasets = [];
    let colorIndex = 0;
    Object.keys(chartData.capacities).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(capacity => {
        const capacityData = chartData.capacities[capacity];
        const color = colors[colorIndex % colors.length];
        datasets.push({
            label: capacity,
            data: capacityData.data,
            borderColor: color,
            backgroundColor: color+'33',
            borderWidth: 2.5,
            tension:0.1,
            pointRadius:0
        });
        if (capacityData.list_price !== null) {
            datasets.push({
                label:`${capacity} 定価`,
                data: capacityData.data.map(d=>({x:d.x,y:capacityData.list_price})),
                borderColor: color,
                borderWidth:1.5,
                borderDash:[5,5],
                pointRadius:0,
                fill:false
            });
        }
        colorIndex++;
    });

    chartInstance = new Chart(ctx,{
        type:'line',
        data:{datasets:datasets},
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{
                x:{
                    type:'time',
                    time:{
                        tooltipFormat:'yyyy/MM/dd HH:mm',
                        displayFormats:{day:'MM/dd', hour:'MM/dd HH:mm'}
                    },
                    title:{display:true,text:'日付'}
                },
                y:{
                    title:{display:true,text:'価格 (円)'},
                    ticks:{
                        callback:value=>'¥'+value.toLocaleString()
                    }
                }
            },
            plugins:{
                tooltip:{
                    callbacks:{
                        label:function(context){
                            let label = context.dataset.label || '';
                            if(label) label += ': ';
                            if(context.parsed.y !== null) label += '¥'+context.parsed.y.toLocaleString();
                            return label;
                        }
                    }
                }
            }
        }
    });
}

function selectPeriod(model, period, btnElement){
    document.querySelectorAll('#period-selector button').forEach(b=>b.classList.remove('active-btn'));
    btnElement.classList.add('active-btn');
    createChart(model,period);
}

function selectModel(model, btnElement){
    document.querySelectorAll('#model-selector button').forEach(b=>b.classList.remove('active-btn'));
    btnElement.classList.add('active-btn');

    const periodSelector = document.getElementById('period-selector');
    periodSelector.innerHTML = '';
    const periods = Array.from(modelInfo[model].periods).sort((a,b)=>{
        const order=['1週間','1ヶ月','3ヶ月','6ヶ月'];
        return order.indexOf(a)-order.indexOf(b);
    });
    periods.forEach(period=>{
        const btn=document.createElement('button');
        btn.textContent=period;
        btn.className='period-btn';
        btn.addEventListener('click',()=>selectPeriod(model,period,btn));
        periodSelector.appendChild(btn);
    });

    document.getElementById('graph-container').innerHTML=`<p class="text-center p-8 text-slate-500">期間を選択してください。</p>`;
    if(chartInstance) chartInstance.destroy();
}

async function initializePage(){
    const modelSelector=document.getElementById('model-selector');
    const showError=msg=>{
        modelSelector.innerHTML='';
        document.getElementById('graph-container').innerHTML=`<p class="text-center p-8 text-red-500">${msg}</p>`;
    };
    try{
        const response=await fetch(CSV_URL);
        if(!response.ok) throw new Error('CSV取得エラー: '+response.statusText);
        const csvText=await response.text();
        const rows=csvText.trim().split(/\r?\n/).map(r=>r.split(','));
        if(rows.length<5) throw new Error('CSVデータが不十分です。');
        const dataRows=rows.slice(4);

        const modelOrder=['iPhone 14','iPhone 14 Plus','iPhone 14 Pro','iPhone 14 Pro MAX','iPhone 15','iPhone 15 Plus','iPhone 15 Pro','iPhone 15 Pro MAX','iPhone 16','iPhone 16 Plus','iPhone 16 Pro','iPhone 16 Pro MAX'];

        modelOrder.forEach(model=>{
            for(let c=0;c<rows[1].length;c++){
                if(rows[1][c].trim()===model){
                    // 機種・期間・容量・定価を取得
                    const period=rows[0][c].trim();
                    const capacity=rows[2][c].trim();
                    const list_price=parsePrice(rows[3][c]);

                    if(!allData[model]){ allData[model]={}; modelInfo[model]={periods:new Set()}; }
                    if(!allData[model][period]) allData[model][period]={capacities:{}};
                    if(!allData[model][period].capacities[capacity]) allData[model][period].capacities[capacity]={list_price:list_price,data:[]};
                    modelInfo[model].periods.add(period);

                    // 日付データの探索（左方向に空白セルまで）
                    let startCol=c;
                    let dateCol=null;
                    for(let x=c;x>=0;x--){
                        if(rows[4][x].trim()!=='' && isNaN(rows[4][x].trim())){ dateCol=x; break; }
                    }
                    if(dateCol===null) continue;

                    // データ範囲はc列（対象機種容量）とdateCol列（横軸）
                    for(let r=0;r<dataRows.length;r++){
                        const dateStr=dataRows[r][dateCol].trim();
                        const price=parsePrice(dataRows[r][c]);
                        if(dateStr && price!==null) allData[model][period].capacities[capacity].data.push({x:dateStr,y:price});
                    }
                }
            }
        });

        // 機種ボタン生成
        modelSelector.innerHTML='';
        modelOrder.forEach(model=>{
            if(allData[model]){
                const btn=document.createElement('button');
                btn.textContent=model;
                btn.className='model-btn';
                btn.addEventListener('click',()=>selectModel(model,btn));
                modelSelector.appendChild(btn);
            }
        });
        if(Object.keys(modelInfo).length===0) showError('解析できる機種データがありません。CSV形式を確認してください。');
    }catch(e){
        console.error(e);
        showError('データ取得または処理に失敗しました。<br>エラー: '+e.message);
    }
}

document.addEventListener('DOMContentLoaded',()=>initializePage());
</script>

</body>
</html>
