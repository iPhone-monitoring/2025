<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>相場グラフ - iPhone相場</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Inter','Noto Sans JP',sans-serif; background:#f8fafc; color:#1e293b; }
  main { max-width:1000px; margin:2rem auto; }
  .btn { cursor:pointer; padding:0.5rem 1rem; margin:0.2rem; border-radius:0.375rem; border:1px solid #cbd5e1; background:#fff; color:#334155; font-weight:500; transition:0.2s; }
  .btn:hover { background:#f1f5f9; }
  .active { background:#2563eb; color:#fff; border-color:#2563eb; }
  #graph-container { min-height:400px; background:#fff; padding:1rem; border-radius:0.5rem; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
</style>
</head>
<body>
<main>
  <h1 class="text-2xl font-bold mb-4">iPhone過去相場グラフ</h1>
  <div id="model-selector" class="mb-4"></div>
  <div id="period-selector" class="mb-4"></div>
  <div id="capacity-selector" class="mb-4"></div>
  <div id="graph-container"><p class="text-center text-slate-500 p-8">機種と期間を選択してください。</p></div>
</main>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYONNTc5QlfCluQxJ6p8Lqt_6wECfxf-o-ynkbVz8viX1-UlZAQmgSLBPSEyhk7UwXrCJuarhIr-6z/pub?gid=761980576&single=true&output=csv';

let csvRows = [];
let chartInstance = null;

// CSV取得
async function fetchCSV() {
  const res = await fetch(CSV_URL);
  if (!res.ok) throw new Error('CSV取得失敗');
  const text = await res.text();
  csvRows = text.split(/\r?\n/).map(r=>r.split(','));
}

// 価格文字列を数字に変換
function parsePrice(str){ return str ? parseFloat(str.replace(/[^0-9]/g,'')) : null; }

// 機種ボタン作成
function createModelButtons() {
  const modelSet = new Set(csvRows[1].slice(1).filter(v=>v));
  const container = document.getElementById('model-selector');
  container.innerHTML = '';
  modelSet.forEach(model=>{
    const btn = document.createElement('button');
    btn.textContent = model;
    btn.className='btn';
    btn.addEventListener('click',()=>selectModel(model, btn));
    container.appendChild(btn);
  });
}

// 機種選択
function selectModel(model, btnElement) {
  document.querySelectorAll('#model-selector .btn').forEach(b=>b.classList.remove('active'));
  btnElement.classList.add('active');
  createPeriodButtons(model);
}

// 対象列取得（機種＋期間）
function getColumns(model, period){
  const cols = [];
  const header = csvRows[1];
  const periods = csvRows[0];
  for(let c=1;c<header.length;c++){
    if(header[c]===model && periods[c]===period) cols.push(c);
  }
  return cols;
}

// 期間ボタン作成
function createPeriodButtons(model){
  const periodSet = new Set();
  for(let c=1;c<csvRows[1].length;c++){
    if(csvRows[1][c]===model) periodSet.add(csvRows[0][c]);
  }
  const sorted = Array.from(periodSet).sort((a,b)=>{
    const map={'1週間':0,'1ヶ月':1,'3ヶ月':2,'6ヶ月':3};
    return (map[a]||10)-(map[b]||10);
  });
  const container = document.getElementById('period-selector');
  container.innerHTML='';
  sorted.forEach(period=>{
    const btn=document.createElement('button');
    btn.textContent=period; btn.className='btn';
    btn.addEventListener('click',()=>selectPeriod(model, period, btn));
    container.appendChild(btn);
  });
}

// 期間選択
function selectPeriod(model, period, btnElement){
  document.querySelectorAll('#period-selector .btn').forEach(b=>b.classList.remove('active'));
  btnElement.classList.add('active');
  createCapacityButtons(model, period);
}

// 容量ボタン作成
function createCapacityButtons(model, period){
  const cols = getColumns(model, period);
  const capacities = cols.map(c=>csvRows[2][c]);
  const container = document.getElementById('capacity-selector');
  container.innerHTML='';
  capacities.forEach((cap,cidx)=>{
    const btn=document.createElement('button');
    btn.textContent=cap; btn.className='btn';
    btn.addEventListener('click',()=>drawChart(model, period, cap, cols[cidx]));
    container.appendChild(btn);
  });
  document.getElementById('graph-container').innerHTML='<p class="text-center text-slate-500 p-8">容量を選択してください。</p>';
}

// 横軸列取得（左方向探索）
function getDateColumn(targetCol){
  for(let c=targetCol-1;c>=0;c--){
    let found=false;
    for(let r=4;r<csvRows.length;r++){
      if(csvRows[r][c] && isNaN(csvRows[r][c])){ found=true; break; }
    }
    if(found) return c;
  }
  return null;
}

// グラフ描画
function drawChart(model, period, capacity, col){
  const dateCol = getDateColumn(col);
  if(dateCol===null){ alert('横軸日付が見つかりません'); return; }

  const data=[];
  for(let r=4;r<csvRows.length;r++){
    const date=csvRows[r][dateCol];
    const price=parsePrice(csvRows[r][col]);
    if(date && price!==null) data.push({x:date, y:price});
    else if(!date) break; // 空白セルで終了
  }
  const listPrice=parsePrice(csvRows[3][col]);
  
  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('priceChart') || (()=>{
    const container=document.getElementById('graph-container');
    container.innerHTML='<canvas id="priceChart"></canvas>';
    return document.getElementById('priceChart');
  })().getContext('2d');

  const datasets=[{
    label:capacity,
    data:data,
    borderColor:'#3b82f6',
    backgroundColor:'#3b82f633',
    borderWidth:2.5,
    tension:0.1,
    pointRadius:2,
    pointHoverRadius:5
  }];

  if(listPrice!==null){
    datasets.push({
      label:capacity+' 定価',
      data:data.map(d=>({x:d.x, y:listPrice})),
      borderColor:'#3b82f6',
      borderWidth:1.5,
      borderDash:[5,5],
      pointRadius:0,
      fill:false
    });
  }

  chartInstance = new Chart(ctx, {
    type:'line',
    data:{datasets:datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ type:'category', title:{display:true,text:'日付'} },
        y:{ title:{display:true,text:'価格(円)'},
            ticks:{ callback:v=>'¥'+v.toLocaleString() } }
      },
      plugins:{
        tooltip:{
          callbacks:{
            label:ctx=>ctx.dataset.label+': ¥'+ctx.parsed.y.toLocaleString()
          }
        }
      }
    }
  });
}

// 初期化
document.addEventListener('DOMContentLoaded',async()=>{
  await fetchCSV();
  createModelButtons();
});
</script>
</body>
</html>
